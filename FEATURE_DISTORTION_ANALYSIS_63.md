# –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ò–°–ö–ê–ñ–ï–ù–ò–ô –î–ê–ù–ù–´–• –ü–û 63 –ü–†–ò–ó–ù–ê–ö–ê–ú

> **–¶–µ–ª—å**: –ü—Ä–æ–≤–µ—Å—Ç–∏ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –∏–∑ 63 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ observation vector, –∏–∑—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–æ –∑–∞–ø–∏—Å–∏ –≤ observation, –≤—ã—è–≤–∏—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è –∏ data leakage

> **–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è**: –ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö ML (Goodfellow, Raschka), –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (CFA Institute), –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö (OWASP, IEEE 754)

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞**: 2025-11-16
**–í–µ—Ä—Å–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤**: 63 features (v63, –¥–æ–±–∞–≤–ª–µ–Ω atr_valid flag)
**–¢–∞–π–º—Ñ—Ä–µ–π–º**: 4h candles

---

## üìä –≠–¢–ê–ü 1: –ü–†–ò–ó–ù–ê–ö–ò 0-5 (Bar Level Features)

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ0: `price` (–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: Binance API ‚Üí CSV —Ñ–∞–π–ª
   ‚îú‚îÄ –§–∞–π–ª: data/klines_4h/{SYMBOL}.csv
   ‚îú‚îÄ –ö–æ–ª–æ–Ω–∫–∞: "close" (—Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è 4h —Å–≤–µ—á–∏)
   ‚îî‚îÄ –§–æ—Ä–º–∞—Ç: Float, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ü–µ–Ω—É –≤ USDT

2. –ó–ê–ì–†–£–ó–ö–ê: prepare_and_run.py:_read_raw()
   ‚îú‚îÄ –ß—Ç–µ–Ω–∏–µ CSV ‚Üí DataFrame
   ‚îú‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ timestamp = (close_time // 14400) * 14400
   ‚îî‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è: –ù–ï–¢ (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å)

3. –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø: features_pipeline.py
   ‚îú‚îÄ –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è z-score –¥–ª—è "close"
   ‚îî‚îÄ –ö–æ–ª–æ–Ω–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –≤–∏–¥–µ

4. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï: mediator.py:1052
   ‚îú‚îÄ –ú–µ—Ç–æ–¥: _validate_critical_price(mark_price)
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∏:
   ‚îÇ  ‚úì isnan(price) ‚Üí ValueError
   ‚îÇ  ‚úì isinf(price) ‚Üí ValueError
   ‚îÇ  ‚úì price <= 0.0 ‚Üí ValueError
   ‚îî‚îÄ Fail-fast –≤–∞–ª–∏–¥–∞—Ü–∏—è (–∫–æ–¥: obs_builder.pyx:633)

5. –ó–ê–ü–ò–°–¨: obs_builder.pyx:237
   ‚îî‚îÄ out_features[0] = price (–±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π)
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Look-ahead bias** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Data leakage** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **NaN propagation** | ‚úÖ **–ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–û** | CRITICAL | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è** | ‚ö†Ô∏è **–ù–ï–¢ –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–ò** | MEDIUM | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π:**

**1. Look-ahead bias: –û–¢–°–£–¢–°–¢–í–£–ï–¢** ‚úÖ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `close` —Ü–µ–Ω–∞ –¢–ï–ö–£–©–ï–ô —Å–≤–µ—á–∏
- –ù–ï–¢ –¥–æ—Å—Ç—É–ø–∞ –∫ –±—É–¥—É—â–∏–º —Ü–µ–Ω–∞–º
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**2. NaN/Inf protection: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê** ‚úÖ
- **P0 —É—Ä–æ–≤–µ–Ω—å** (mediator.py:1052): `_validate_critical_price()`
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ `isnan(price)` ‚Üí ValueError
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ `isinf(price)` ‚Üí ValueError
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ `price <= 0` ‚Üí ValueError
- **P1 —É—Ä–æ–≤–µ–Ω—å** (obs_builder.pyx:633): `_validate_price(price, "price")`
  - –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
  - Fail-fast –ø–æ–¥—Ö–æ–¥: –æ—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –î–û –∑–∞–ø–∏—Å–∏ –≤ observation

**3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏: –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê** ‚ö†Ô∏è
- –¶–µ–Ω–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 50000 USDT –¥–ª—è BTC)
- –î—Ä—É–≥–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [-1, 1] —á–µ—Ä–µ–∑ tanh
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: –†–∞–∑–Ω—ã–µ –º–∞—Å—à—Ç–∞–±—ã –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –º–æ–≥—É—Ç —É—Å–ª–æ–∂–Ω–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é —Ü–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, log(price) –∏–ª–∏ z-score)

#### üî¨ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º:**

–°–æ–≥–ª–∞—Å–Ω–æ –ª—É—á—à–∏–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è:
- "Feature Scaling for Machine Learning" (Sebastian Raschka): –ü—Ä–∏–∑–Ω–∞–∫–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –º–∞—Å—à—Ç–∞–±–∞–º–∏ –¥–æ–ª–∂–Ω—ã –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å—Å—è
- "Deep Learning" (Ian Goodfellow): –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º—ã–µ –º–∞—Å—à—Ç–∞–±—ã

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ1: `log_volume_norm` (–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–º —Ç–æ—Ä–≥–æ–≤)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: Binance API ‚Üí CSV
   ‚îú‚îÄ –ö–æ–ª–æ–Ω–∫–∞: "quote_asset_volume" (–æ–±—ä–µ–º –≤ USDT)
   ‚îî‚îÄ –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞: close * volume

2. –ó–ê–ì–†–£–ó–ö–ê: prepare_and_run.py:46
   ‚îú‚îÄ –ï—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–∑ close * volume
   ‚îî‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è: –ù–ï–¢

3. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï: mediator.py:1059
   ‚îú‚îÄ quote_volume = _get_safe_float(row, "quote_asset_volume", 1.0, min_value=0.0)
   ‚îú‚îÄ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê**: min_value=0.0 –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
   ‚îî‚îÄ Reason: log1p(x < -1) ‚Üí NaN

4. –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø: mediator.py:1064-1065
   ‚îú‚îÄ –§–æ—Ä–º—É–ª–∞: tanh(log1p(quote_volume / 240e6))
   ‚îú‚îÄ –î–µ–ª–∏—Ç–µ–ª—å 240e6: –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è 4h —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
   ‚îÇ  ‚îî‚îÄ 4h –±–∞—Ä—ã = 240x –±–æ–ª—å—à–µ –æ–±—ä–µ–º–∞ —á–µ–º 1h –±–∞—Ä—ã
   ‚îî‚îÄ tanh(log1p(x)) ‚Üí –¥–∏–∞–ø–∞–∑–æ–Ω (-1, 1)

5. –í–ê–õ–ò–î–ê–¶–ò–Ø: obs_builder.pyx:639
   ‚îú‚îÄ _validate_volume_metric(log_volume_norm, "log_volume_norm")
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∏:
   ‚îÇ  ‚úì isnan() ‚Üí ValueError
   ‚îÇ  ‚úì isinf() ‚Üí ValueError
   ‚îî‚îÄ Fail-fast –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é

6. –ó–ê–ü–ò–°–¨: obs_builder.pyx:239
   ‚îî‚îÄ out_features[1] = log_volume_norm
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Domain error (log1p)** | ‚úÖ **–ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–û** | CRITICAL | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| **NaN propagation** | ‚úÖ **–ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–û** | CRITICAL | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| **Look-ahead bias** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Normalization leak** | ‚ö†Ô∏è **HARDCODED DIVISOR** | LOW | ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π:**

**1. Domain error protection: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê** ‚úÖ
- **–ü—Ä–æ–±–ª–µ–º–∞**: `log1p(x)` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è `x > -1`
- **–ó–∞—â–∏—Ç–∞ P0** (mediator.py:1059):
  ```python
  quote_volume = _get_safe_float(row, "quote_asset_volume", 1.0, min_value=0.0)
  ```
  - `min_value=0.0` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç `quote_volume >= 0`
  - –° `volume >= 0`: `log1p(volume / 240e6)` –≤—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–µ–Ω
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: NaN –∏–∑-–∑–∞ log1p –ù–ï–í–û–ó–ú–û–ñ–ï–ù

**2. Hardcoded normalization divisor: –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê** ‚ö†Ô∏è
- **–î–µ–ª–∏—Ç–µ–ª—å 240e6** –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω –¥–ª—è BTC/USDT 4h
- **–ü—Ä–æ–±–ª–µ–º–∞**: –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ –æ–±—ä–µ–º –º–æ–∂–µ—Ç —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è
  - Altcoins: –æ–±—ä–µ–º –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ 100-1000x –º–µ–Ω—å—à–µ
  - –†–µ–∑—É–ª—å—Ç–∞—Ç: `log_volume_norm` –±—É–¥–µ—Ç —Å–∏–ª—å–Ω–æ —Å–º–µ—â–µ–Ω –≤ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–æ–∫–µ–Ω–∞

**3. IEEE 754 NaN propagation: –ó–ê–©–ò–¢–ê** ‚úÖ
- **P2 —É—Ä–æ–≤–µ–Ω—å** (obs_builder.pyx:639): `_validate_volume_metric()`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ observation vector
- –°–æ–≥–ª–∞—Å–Ω–æ IEEE 754: –ª—é–±–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Å NaN ‚Üí NaN
- Fail-fast –ø–æ–¥—Ö–æ–¥ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ NaN

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ2: `rel_volume` (–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—ä–µ–º)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: Binance API ‚Üí CSV
   ‚îú‚îÄ –ö–æ–ª–æ–Ω–∫–∞: "volume" (–±–∞–∑–æ–≤—ã–π –æ–±—ä–µ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä BTC)
   ‚îî‚îÄ –§–æ—Ä–º–∞—Ç: Float

2. –ó–ê–ì–†–£–ó–ö–ê: prepare_and_run.py:48
   ‚îî‚îÄ –í–∞–ª–∏–¥–∞—Ü–∏—è: –ù–ï–¢

3. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï: mediator.py:1058
   ‚îú‚îÄ volume = _get_safe_float(row, "volume", 1.0, min_value=0.0)
   ‚îî‚îÄ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê**: min_value=0.0

4. –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø: mediator.py:1068-1069
   ‚îú‚îÄ –§–æ—Ä–º—É–ª–∞: tanh(log1p(volume / 24000.0))
   ‚îú‚îÄ –î–µ–ª–∏—Ç–µ–ª—å 24000.0: –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è 4h —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
   ‚îî‚îÄ tanh(log1p(x)) ‚Üí –¥–∏–∞–ø–∞–∑–æ–Ω (-1, 1)

5. –í–ê–õ–ò–î–ê–¶–ò–Ø: obs_builder.pyx:640
   ‚îî‚îÄ _validate_volume_metric(rel_volume, "rel_volume")

6. –ó–ê–ü–ò–°–¨: obs_builder.pyx:242
   ‚îî‚îÄ out_features[2] = rel_volume
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Domain error (log1p)** | ‚úÖ **–ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–û** | CRITICAL | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| **Hardcoded divisor** | ‚ö†Ô∏è **24000.0 –¥–ª—è BTC** | MEDIUM | ‚ö†Ô∏è –¢–æ–∫–µ–Ω-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π:**

**1. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –∑–∞—â–∏—Ç–∞ –∫–∞–∫ log_volume_norm** ‚úÖ
- –¢–∞ –∂–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞—â–∏—Ç—ã P0/P2
- `min_value=0.0` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç domain errors

**2. –¢–æ–∫–µ–Ω-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –¥–µ–ª–∏—Ç–µ–ª—å: –ü–†–û–ë–õ–ï–ú–ê** ‚ö†Ô∏è
- **24000.0** –ø–æ–¥–æ–±—Ä–∞–Ω –¥–ª—è BTC –Ω–∞ 4h —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ
- –î–ª—è —Ç–æ–∫–µ–Ω–æ–≤ —Å –º–∞–ª—ã–º –æ–±—ä–µ–º–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, altcoins):
  - –û–±—ä–µ–º –º–æ–∂–µ—Ç –±—ã—Ç—å 0.01-10 BTC (vs 24000)
  - `rel_volume` –±—É–¥–µ—Ç –±–ª–∏–∑–æ–∫ –∫ -1.0 (–ø–æ—Å–ª–µ tanh)
  - –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–∑–ª–∏—á–∞—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É 0.01 –∏ 10 BTC
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–ª–∏—Ç–µ–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ3: `ma5` (5-–ø–µ—Ä–∏–æ–¥–Ω–∞—è —Å–∫–æ–ª—å–∑—è—â–∞—è —Å—Ä–µ–¥–Ω—è—è)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: transformers.py
   ‚îú‚îÄ –ò–º—è –∫–æ–ª–æ–Ω–∫–∏: "sma_1200" (SMA –∑–∞ 1200 –º–∏–Ω—É—Ç)
   ‚îú‚îÄ –†–∞—Å—á–µ—Ç: 5 –±–∞—Ä–æ–≤ √ó 240 –º–∏–Ω/–±–∞—Ä = 1200 –º–∏–Ω—É—Ç = 20 —á–∞—Å–æ–≤
   ‚îî‚îÄ –§–æ—Ä–º—É–ª–∞: SMA(close, 5)

2. –í–´–ß–ò–°–õ–ï–ù–ò–ï: transformers.py (SimpleMovingAverage)
   ‚îú‚îÄ Buffer: deque —Å —Ä–∞–∑–º–µ—Ä–æ–º window=5
   ‚îú‚îÄ Warmup period: –ø–µ—Ä–≤—ã–µ 5 –±–∞—Ä–æ–≤
   ‚îú‚îÄ –î–æ warmup: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç NaN
   ‚îî‚îÄ –ü–æ—Å–ª–µ warmup: sum(buffer) / len(buffer)

3. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï: mediator.py:1083
   ‚îú‚îÄ ma5 = _get_safe_float(row, "sma_1200", float('nan'))
   ‚îî‚îÄ **–í–ê–ñ–ù–û**: Default = NaN (–ù–ï 0.0)

4. –û–ë–†–ê–ë–û–¢–ö–ê NaN: obs_builder.pyx:244-248
   ‚îú‚îÄ ma5_valid = not isnan(ma5)
   ‚îú‚îÄ –ï—Å–ª–∏ NaN ‚Üí ma5 = 0.0, ma5_valid = 0.0
   ‚îú‚îÄ –ï—Å–ª–∏ –≤–∞–ª–∏–¥–µ–Ω ‚Üí ma5 = ma5, ma5_valid = 1.0
   ‚îî‚îÄ **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –†–ï–®–ï–ù–ò–ï**: Validity flag —É—Å—Ç—Ä–∞–Ω—è–µ—Ç ambiguity

5. –ó–ê–ü–ò–°–¨: obs_builder.pyx:245-248
   ‚îú‚îÄ out_features[3] = ma5 if ma5_valid else 0.0
   ‚îî‚îÄ out_features[4] = 1.0 if ma5_valid else 0.0
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Look-ahead bias** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Warmup ambiguity** | ‚úÖ **–†–ï–®–ï–ù–û —á–µ—Ä–µ–∑ validity flag** | HIGH | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| **Fallback value** | ‚ö†Ô∏è **0.0 –º–æ–∂–µ—Ç –≤–≤–µ—Å—Ç–∏ –≤ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ** | MEDIUM | ‚ö†Ô∏è –ü—Ä–∏–µ–º–ª–µ–º–æ |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π:**

**1. Look-ahead bias: –û–¢–°–£–¢–°–¢–í–£–ï–¢** ‚úÖ
- SMA –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –ü–†–û–®–õ–´–ú —Ü–µ–Ω–∞–º
- –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –ù–ï –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç (–ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è online —Ä–µ–∂–∏–º–∞)
- –í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ–±–ª—é–¥–µ–Ω–∞

**2. Warmup ambiguity: –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –†–ï–®–ï–ù–ò–ï** ‚úÖ
- **–ü—Ä–æ–±–ª–µ–º–∞**:
  - –ü–µ—Ä–≤—ã–µ 5 –±–∞—Ä–æ–≤: `ma5 = NaN` ‚Üí fallback `0.0`
  - –ü–æ—Å–ª–µ 5 –±–∞—Ä–æ–≤: `ma5 = 0.0` –µ—Å–ª–∏ —Ü–µ–Ω—ã –æ–∫–æ–ª–æ –Ω—É–ª—è
  - **Ambiguity**: –ú–æ–¥–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–∑–ª–∏—á–∏—Ç—å "–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö" –æ—Ç "—Ä–µ–∞–ª—å–Ω—ã–π 0.0"

- **–†–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ validity flag**:
  ```python
  ma5_valid = not isnan(ma5)
  out_features[3] = ma5 if ma5_valid else 0.0  # –∑–Ω–∞—á–µ–Ω–∏–µ
  out_features[4] = 1.0 if ma5_valid else 0.0  # —Ñ–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
  ```

- **–≠—Ñ—Ñ–µ–∫—Ç**:
  - Warmup period: `[0.0, 0.0]` (–∑–Ω–∞—á–µ–Ω–∏–µ + —Ñ–ª–∞–≥)
  - –ü–æ—Å–ª–µ warmup: `[ma5_value, 1.0]`
  - –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –†–ê–ó–õ–ò–ß–ò–¢–¨ —ç—Ç–∏ —Å–ª—É—á–∞–∏

- **–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è**:
  - "Incomplete Data - Machine Learning Trading" (OMSCS): Validity flags –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è missing vs real data
  - "Defense in Depth" (OWASP): Multiple validation layers

**3. Fallback value 0.0: –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê** ‚ö†Ô∏è
- **–ü—Ä–æ–±–ª–µ–º–∞**: –î–ª—è —Ç–æ–∫–µ–Ω–æ–≤ —Å —Ü–µ–Ω–æ–π ~$0.01, `ma5 = 0.0` –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
- **–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: Validity flag —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É
- **–í—ã–≤–æ–¥**: –ü—Ä–∏–µ–º–ª–µ–º–æ –±–ª–∞–≥–æ–¥–∞—Ä—è —Ñ–ª–∞–≥—É –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ4: `ma5_valid` (–§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ MA5)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: –õ–æ–≥–∏–∫–∞ obs_builder.pyx:244
   ‚îî‚îÄ ma5_valid = not isnan(ma5)

2. –ó–ê–ü–ò–°–¨: obs_builder.pyx:247
   ‚îî‚îÄ out_features[4] = 1.0 if ma5_valid else 0.0
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Look-ahead bias** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Correctness** | ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞** | - | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

**1. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ñ–ª–∞–≥–∞** ‚úÖ
- –õ–æ–≥–∏–∫–∞ –ø—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è: `not isnan(ma5)`
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –æ—à–∏–±–æ–∫
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç best practices

**2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ** ‚úÖ
- –°–æ–≥–ª–∞—Å–Ω–æ "Incomplete Data - Machine Learning Trading":
  - Validity flags –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏
  - –ú–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –ù–ê–£–ß–ò–¢–¨–°–Ø –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö
  - –≠—Ç–æ –ª—É—á—à–µ —á–µ–º imputation (–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤)

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ5: `ma20` (20-–ø–µ—Ä–∏–æ–¥–Ω–∞—è —Å–∫–æ–ª—å–∑—è—â–∞—è —Å—Ä–µ–¥–Ω—è—è)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: transformers.py
   ‚îú‚îÄ –ò–º—è –∫–æ–ª–æ–Ω–∫–∏: "sma_5040" (SMA –∑–∞ 5040 –º–∏–Ω—É—Ç)
   ‚îú‚îÄ –†–∞—Å—á–µ—Ç: 21 –±–∞—Ä–æ–≤ √ó 240 –º–∏–Ω/–±–∞—Ä = 5040 –º–∏–Ω—É—Ç = 84h ‚âà 3.5 –¥–Ω—è
   ‚îî‚îÄ –§–æ—Ä–º—É–ª–∞: SMA(close, 21)

2. –í–´–ß–ò–°–õ–ï–ù–ò–ï: transformers.py (SimpleMovingAverage)
   ‚îú‚îÄ Buffer: deque —Å —Ä–∞–∑–º–µ—Ä–æ–º window=21
   ‚îú‚îÄ Warmup period: –ø–µ—Ä–≤—ã–µ 21 –±–∞—Ä
   ‚îú‚îÄ –î–æ warmup: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç NaN
   ‚îî‚îÄ –ü–æ—Å–ª–µ warmup: sum(buffer) / len(buffer)

3. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï: mediator.py:1086
   ‚îú‚îÄ ma20 = _get_safe_float(row, "sma_5040", float('nan'))
   ‚îî‚îÄ Default = NaN

4. –û–ë–†–ê–ë–û–¢–ö–ê NaN: obs_builder.pyx:250-253
   ‚îú‚îÄ ma20_valid = not isnan(ma20)
   ‚îú‚îÄ Fallback: 0.0
   ‚îî‚îÄ Validity flag –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è

5. –ó–ê–ü–ò–°–¨: obs_builder.pyx:251-253
   ‚îú‚îÄ out_features[5] = ma20 if ma20_valid else 0.0
   ‚îî‚îÄ out_features[6] = 1.0 if ma20_valid else 0.0 (–≤ —Å–ª–µ–¥—É—é—â–µ–º –∏–Ω–¥–µ–∫—Å–µ)
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Look-ahead bias** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Warmup period** | ‚úÖ **21 –±–∞—Ä (84h)** | - | ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| **Validity flag** | ‚úÖ **–ò–º–µ–µ—Ç—Å—è** | - | ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç ambiguity |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

**1. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–∞–∫ MA5** ‚úÖ
- –¢–µ –∂–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
- Validity flag –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç ambiguity
- Warmup period –¥–æ–ª—å—à–µ (21 vs 5 –±–∞—Ä–æ–≤)

**2. –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é** ‚ö†Ô∏è
- **–í–ù–ò–ú–ê–ù–ò–ï**: –ü—Ä–∏–∑–Ω–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `ma20`, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `sma_5040` (21 –±–∞—Ä)
- **–ü—Ä–∏—á–∏–Ω–∞**: –ú–∏–≥—Ä–∞—Ü–∏—è —Å 1h –Ω–∞ 4h —Ç–∞–π–º—Ñ—Ä–µ–π–º
  - –ù–∞ 1h: MA20 = 20 —á–∞—Å–æ–≤
  - –ù–∞ 4h: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 21 –±–∞—Ä (84h ‚âà 3.5 –¥–Ω—è) –¥–ª—è weekly trend
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—É—Ç–∞–Ω–∏—Ü–∞**: –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–∏–æ–¥—É
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ `ma21` –∏–ª–∏ `ma_weekly` –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏

---

## üìã **–°–í–û–î–ö–ê –ü–û –≠–¢–ê–ü–£ 1 (–ü—Ä–∏–∑–Ω–∞–∫–∏ 0-5)**

### ‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:**

1. **Fail-fast –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ NaN/Inf
2. **Validity flags** - —É—Å—Ç—Ä–∞–Ω—è—é—Ç ambiguity –¥–ª—è MA5/MA20
3. **Domain error protection** - log1p –∑–∞—â–∏—â–µ–Ω –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
4. **Look-ahead bias** - –û–¢–°–£–¢–°–¢–í–£–ï–¢ –≤–æ –≤—Å–µ—Ö –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö

### ‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ü–µ–Ω—ã** (–ø—Ä–∏–∑–Ω–∞–∫ ‚Ññ0) - —Ä–∞–∑–Ω—ã–µ –º–∞—Å—à—Ç–∞–±—ã –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
2. **Hardcoded divisors** –¥–ª—è volume (–ø—Ä–∏–∑–Ω–∞–∫–∏ ‚Ññ1-2) - —Ç–æ–∫–µ–Ω-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
3. **Naming inconsistency** (–ø—Ä–∏–∑–Ω–∞–∫ ‚Ññ5) - ma20 —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ ma21

### üéØ **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. **HIGH**: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è `price` (log –∏–ª–∏ z-score)
2. **MEDIUM**: –°–¥–µ–ª–∞—Ç—å volume divisors –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
3. **LOW**: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `ma20` ‚Üí `ma21` –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

---

## üìä –≠–¢–ê–ü 2: –ü–†–ò–ó–ù–ê–ö–ò 6-12 (Technical Indicators with Validity Flags)

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ6: `ma20_valid` (–§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ MA20)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: –õ–æ–≥–∏–∫–∞ obs_builder.pyx:250
   ‚îî‚îÄ ma20_valid = not isnan(ma20)

2. –ó–ê–ü–ò–°–¨: obs_builder.pyx:253
   ‚îî‚îÄ out_features[6] = 1.0 if ma20_valid else 0.0
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Look-ahead bias** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Correctness** | ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞** | - | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

**1. –ò–¥–µ–Ω—Ç–∏—á–µ–Ω ma5_valid** ‚úÖ
- –¢–∞ –∂–µ –ø—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
- Warmup period: 21 –±–∞—Ä –≤–º–µ—Å—Ç–æ 5
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ7: `rsi14` (RSI –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: MarketSimulator.cpp
   ‚îú‚îÄ –†–∞—Å—á–µ—Ç: Wilder's RSI(14)
   ‚îú‚îÄ –§–æ—Ä–º—É–ª–∞: RSI = 100 - (100 / (1 + RS))
   ‚îÇ  –≥–¥–µ RS = avg_gain_14 / avg_loss_14
   ‚îî‚îÄ Wilder's smoothing: avg = (prev_avg * 13 + current) / 14

2. –í–´–ß–ò–°–õ–ï–ù–ò–ï: MarketSimulator.cpp:310-328
   ‚îú‚îÄ Warmup period: 14 –±–∞—Ä–æ–≤ (–ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
   ‚îú‚îÄ –î–æ warmup: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç NaN
   ‚îú‚îÄ –õ–æ–≥–∏–∫–∞:
   ‚îÇ  - change = close[i] - close[i-1]
   ‚îÇ  - gain = max(change, 0)
   ‚îÇ  - loss = max(-change, 0)
   ‚îÇ  - avg_gain = Wilder_EMA(gain, 14)
   ‚îÇ  - avg_loss = Wilder_EMA(loss, 14)
   ‚îî‚îÄ Edge case: avg_loss == 0 ‚Üí RS = Infinity ‚Üí RSI = 100

3. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï: mediator.py:1087 (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø—É—Ç—å)
   ‚îú‚îÄ rsi14 = _get_safe_float(row, "rsi", 50.0)
   ‚îú‚îÄ –ò–õ–ò —á–µ—Ä–µ–∑ MarketSimulator:
   ‚îÇ  ‚îî‚îÄ sim.get_rsi(row_idx) ‚Üí MarketSimulator.cpp:327
   ‚îî‚îÄ Default fallback: 50.0 (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π RSI)

4. –û–ë–†–ê–ë–û–¢–ö–ê NaN: obs_builder.pyx:257-264
   ‚îú‚îÄ rsi_valid = not isnan(rsi14)
   ‚îú‚îÄ –ï—Å–ª–∏ NaN ‚Üí rsi14 = 50.0, rsi_valid = 0.0
   ‚îú‚îÄ –ï—Å–ª–∏ –≤–∞–ª–∏–¥–µ–Ω ‚Üí rsi14 = rsi14, rsi_valid = 1.0
   ‚îî‚îÄ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê**: Fallback 50.0 –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–º—É RSI!

5. –ó–ê–ü–ò–°–¨: obs_builder.pyx:262-264
   ‚îú‚îÄ out_features[7] = rsi14 if rsi_valid else 50.0
   ‚îî‚îÄ out_features[8] = 1.0 if rsi_valid else 0.0
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Look-ahead bias** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Warmup ambiguity** | ‚úÖ **–†–ï–®–ï–ù–û —á–µ—Ä–µ–∑ validity flag** | HIGH | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| **Division by zero** | ‚úÖ **–û–ë–†–ê–ë–û–¢–ê–ù–û** | CRITICAL | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| **Fallback overlap** | ‚ö†Ô∏è **50.0 = neutral RSI** | HIGH | ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π:**

**1. Wilder's smoothing: –ö–û–†–†–ï–ö–¢–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø** ‚úÖ
- **–§–æ—Ä–º—É–ª–∞** (MarketSimulator.cpp:323-324):
  ```cpp
  avg_gain14 = (avg_gain14 * 13.0 + gain) / 14.0;
  avg_loss14 = (avg_loss14 * 13.0 + loss) / 14.0;
  ```
- **–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –≠—Ç–æ —Ç–æ—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Wilder's EMA
- **–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è**: "New Concepts in Technical Trading Systems" (J. Welles Wilder, 1978)
- **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è**: Œ± = 1/14, EMA = Œ±*x + (1-Œ±)*prev = (prev*13 + x)/14 ‚úÖ

**2. Division by zero protection: –ö–û–†–†–ï–ö–¢–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê** ‚úÖ
- **–ü—Ä–æ–±–ª–µ–º–∞** (MarketSimulator.cpp:325):
  ```cpp
  double rs = (avg_loss14 == 0.0) ? std::numeric_limits<double>::infinity() : (avg_gain14 / avg_loss14);
  ```
- **–û–±—Ä–∞–±–æ—Ç–∫–∞**: –ï—Å–ª–∏ avg_loss == 0 (—Ç–æ–ª—å–∫–æ —Ä–æ—Å—Ç), RS = ‚àû ‚Üí RSI = 100
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å**: –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω–æ (—Å–∏–ª—å–Ω—ã–π –≤–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥)

**3. Fallback ambiguity: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê** ‚ö†Ô∏è
- **–ü—Ä–æ–±–ª–µ–º–∞**:
  - Warmup (–ø–µ—Ä–≤—ã–µ 14 –±–∞—Ä–æ–≤): RSI = NaN ‚Üí fallback 50.0
  - –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫: RSI = 50.0 (—Ä–µ–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
  - **–ë–ï–ó validity flag**: –º–æ–¥–µ–ª—å –ù–ï –ú–û–ñ–ï–¢ —Ä–∞–∑–ª–∏—á–∏—Ç—å —ç—Ç–∏ —Å–ª—É—á–∞–∏

- **–†–µ—à–µ–Ω–∏–µ**: Validity flag —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É
  - Warmup: `[50.0, 0.0]` (value + flag)
  - Neutral: `[50.0, 1.0]` (value + flag)
  - –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç —Ä–∞–∑–ª–∏—á–∏—Ç—å!

**4. Look-ahead bias: –û–¢–°–£–¢–°–¢–í–£–ï–¢** ‚úÖ
- RSI –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–æ—à–ª—ã–º —Ü–µ–Ω–∞–º
- –¢–µ–∫—É—â–∞—è —Å–≤–µ—á–∞ –ù–ï –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç
- –í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å–æ–±–ª—é–¥–µ–Ω–∞

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ8: `rsi_valid` (–§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ RSI)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: –õ–æ–≥–∏–∫–∞ obs_builder.pyx:261
   ‚îî‚îÄ rsi_valid = not isnan(rsi14)

2. –ó–ê–ü–ò–°–¨: obs_builder.pyx:264
   ‚îî‚îÄ out_features[8] = 1.0 if rsi_valid else 0.0
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Correctness** | ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞** | - | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

**1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–∂–Ω–æ—Å—Ç—å –¥–ª—è RSI** ‚úÖ
- RSI(50) –∏–º–µ–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å)
- –ë–µ–∑ —Ñ–ª–∞–≥–∞: ambiguity –º–µ–∂–¥—É "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö" –∏ "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫"
- –° —Ñ–ª–∞–≥–æ–º: –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç —Ä–∞–∑–ª–∏—á–∏—Ç—å —ç—Ç–∏ —Å–ª—É—á–∞–∏
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å**: –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è RSI

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ9: `macd` (MACD –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: MarketSimulator.cpp
   ‚îú‚îÄ –†–∞—Å—á–µ—Ç: MACD = EMA(12) - EMA(26)
   ‚îú‚îÄ EMA —Ñ–æ—Ä–º—É–ª–∞: Œ± = 2/(N+1)
   ‚îÇ  - EMA(12): Œ±‚ÇÅ‚ÇÇ = 2/13 ‚âà 0.1538
   ‚îÇ  - EMA(26): Œ±‚ÇÇ‚ÇÜ = 2/27 ‚âà 0.0741
   ‚îî‚îÄ EMA step: EMA = Œ±*close + (1-Œ±)*prev_EMA

2. –í–´–ß–ò–°–õ–ï–ù–ò–ï: MarketSimulator.cpp:330-337
   ‚îú‚îÄ Warmup period:
   ‚îÇ  - EMA(12): 12 –±–∞—Ä–æ–≤ (–ø–µ—Ä–≤—ã–π –±–∞—Ä = –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
   ‚îÇ  - EMA(26): 26 –±–∞—Ä–æ–≤ (–ø–µ—Ä–≤—ã–π –±–∞—Ä = –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)
   ‚îÇ  - MACD –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ 26 –±–∞—Ä–æ–≤
   ‚îú‚îÄ –ü–µ—Ä–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (MarketSimulator.cpp:259-261):
   ‚îÇ  ‚îî‚îÄ if (!ema12_init) { ema12_init = true; return closev; }
   ‚îú‚îÄ –ü–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
   ‚îÇ  - ema12 = alpha12 * closev + (1-alpha12) * ema12
   ‚îÇ  - ema26 = alpha26 * closev + (1-alpha26) * ema26
   ‚îî‚îÄ macd = ema12 - ema26

3. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï: mediator.py:1090-1091
   ‚îú‚îÄ –ò–õ–ò —á–µ—Ä–µ–∑ MarketSimulator:
   ‚îÇ  ‚îî‚îÄ sim.get_macd(row_idx) ‚Üí MarketSimulator.cpp:336-337
   ‚îî‚îÄ –ò–õ–ò —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –ø—É—Ç—å: macd = 0.0

4. –û–ë–†–ê–ë–û–¢–ö–ê NaN: obs_builder.pyx:271-275
   ‚îú‚îÄ macd_valid = not isnan(macd)
   ‚îú‚îÄ –ï—Å–ª–∏ NaN ‚Üí macd = 0.0, macd_valid = 0.0
   ‚îú‚îÄ –ï—Å–ª–∏ –≤–∞–ª–∏–¥–µ–Ω ‚Üí macd = macd, macd_valid = 1.0
   ‚îî‚îÄ **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï**: Fallback 0.0 —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å "–Ω–µ—Ç –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏"

5. –ó–ê–ü–ò–°–¨: obs_builder.pyx:272-275
   ‚îú‚îÄ out_features[9] = macd if macd_valid else 0.0
   ‚îî‚îÄ out_features[10] = 1.0 if macd_valid else 0.0
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Look-ahead bias** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Warmup ambiguity** | ‚úÖ **–†–ï–®–ï–ù–û —á–µ—Ä–µ–∑ validity flag** | HIGH | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| **EMA initialization** | ‚ö†Ô∏è **–ü–µ—Ä–≤—ã–π –±–∞—Ä = seed** | MEDIUM | ‚ö†Ô∏è –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ |
| **Fallback overlap** | ‚ö†Ô∏è **0.0 = –Ω–µ—Ç –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏** | HIGH | ‚ö†Ô∏è –†–µ—à–µ–Ω–æ —Ñ–ª–∞–≥–æ–º |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π:**

**1. EMA calculation: –ö–û–†–†–ï–ö–¢–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø** ‚úÖ
- **–§–æ—Ä–º—É–ª–∞** (MarketSimulator.cpp:331-335):
  ```cpp
  const double alpha12 = 2.0 / (12.0 + 1.0);  // 0.1538
  const double alpha26 = 2.0 / (26.0 + 1.0);  // 0.0741
  ema12 = ema_step(ema12, closev, alpha12, ema12_init);
  ema26 = ema_step(ema26, closev, alpha26, ema26_init);
  ```
- **ema_step —Ñ—É–Ω–∫—Ü–∏—è** (MarketSimulator.cpp:259-261):
  ```cpp
  if (!init) { init = true; return x; }  // –ø–µ—Ä–≤—ã–π –±–∞—Ä
  return alpha * x + (1.0 - alpha) * prev;  // —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è EMA
  ```
- **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è**: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É MACD (Gerald Appel, 1979)

**2. Warmup period: 26 –ë–ê–†–û–í** ‚úÖ
- EMA(12) –≥–æ—Ç–æ–≤–∞ –ø–æ—Å–ª–µ 12 –±–∞—Ä–æ–≤
- EMA(26) –≥–æ—Ç–æ–≤–∞ –ø–æ—Å–ª–µ 26 –±–∞—Ä–æ–≤
- MACD = EMA(12) - EMA(26) ‚Üí –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ 26 –±–∞—Ä–æ–≤
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å**: –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω–æ

**3. EMA initialization: –°–¢–ê–ù–î–ê–†–¢–ù–ê–Ø –ü–†–ê–ö–¢–ò–ö–ê** ‚ö†Ô∏è
- **–ú–µ—Ç–æ–¥**: –ü–µ—Ä–≤—ã–π –±–∞—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ seed (EMA = close[0])
- **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞**: SMA –ø–µ—Ä–≤—ã—Ö N –±–∞—Ä–æ–≤ –∫–∞–∫ seed
- **–¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥**: –ë–æ–ª–µ–µ –±—ã—Å—Ç—Ä–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è (bias –∫ –ø–µ—Ä–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é)
- **–û—Ü–µ–Ω–∫–∞**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞, –ø—Ä–∏–µ–º–ª–µ–º–æ

**4. Fallback ambiguity: –†–ï–®–ï–ù–û –§–õ–ê–ì–û–ú** ‚úÖ
- **–ü—Ä–æ–±–ª–µ–º–∞**: MACD = 0.0 –æ–∑–Ω–∞—á–∞–µ—Ç "EMA12 = EMA26" (–Ω–µ—Ç –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏)
- **Fallback**: MACD = 0.0 –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- **–†–µ—à–µ–Ω–∏–µ**: Validity flag —Ä–∞–∑–ª–∏—á–∞–µ—Ç —ç—Ç–∏ —Å–ª—É—á–∞–∏
  - Warmup: `[0.0, 0.0]`
  - No divergence: `[0.0, 1.0]`

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ10: `macd_valid` (–§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ MACD)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: –õ–æ–≥–∏–∫–∞ obs_builder.pyx:271
   ‚îî‚îÄ macd_valid = not isnan(macd)

2. –ó–ê–ü–ò–°–¨: obs_builder.pyx:275
   ‚îî‚îÄ out_features[10] = 1.0 if macd_valid else 0.0
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Correctness** | ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞** | - | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

**1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–∂–Ω–æ—Å—Ç—å** ‚úÖ
- MACD = 0 –∏–º–µ–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ—Ç –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏)
- –§–ª–∞–≥ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç ambiguity
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ11: `macd_signal` (MACD Signal Line)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: MarketSimulator.cpp
   ‚îú‚îÄ –†–∞—Å—á–µ—Ç: Signal = EMA(9) of MACD
   ‚îú‚îÄ EMA —Ñ–æ—Ä–º—É–ª–∞: Œ± = 2/(9+1) = 0.2
   ‚îî‚îÄ Signal –ª–∏–Ω–∏—è —Å–≥–ª–∞–∂–∏–≤–∞–µ—Ç MACD –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤

2. –í–´–ß–ò–°–õ–ï–ù–ò–ï: MarketSimulator.cpp:338-339
   ‚îú‚îÄ Warmup period:
   ‚îÇ  - MACD –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ 26 –±–∞—Ä–æ–≤
   ‚îÇ  - Signal = EMA(9) of MACD ‚Üí –≥–æ—Ç–æ–≤ –ø–æ—Å–ª–µ 26+9 = 35 –±–∞—Ä–æ–≤
   ‚îú‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
   ‚îÇ  ‚îî‚îÄ ema9 = ema_step(ema9, macd, alpha9, ema9_init)
   ‚îî‚îÄ –ü–µ—Ä–≤—ã–π MACD –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ seed –¥–ª—è ema9

3. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï: mediator.py:1091-1092
   ‚îú‚îÄ sim.get_macd_signal(row_idx) ‚Üí MarketSimulator.cpp:339
   ‚îî‚îÄ –†–µ–∑–µ—Ä–≤–Ω—ã–π –ø—É—Ç—å: macd_signal = 0.0

4. –û–ë–†–ê–ë–û–¢–ö–ê NaN: obs_builder.pyx:281-285
   ‚îú‚îÄ macd_signal_valid = not isnan(macd_signal)
   ‚îú‚îÄ –ï—Å–ª–∏ NaN ‚Üí macd_signal = 0.0, macd_signal_valid = 0.0
   ‚îú‚îÄ –ï—Å–ª–∏ –≤–∞–ª–∏–¥–µ–Ω ‚Üí macd_signal = macd_signal, macd_signal_valid = 1.0
   ‚îî‚îÄ Validity flag —É—Å—Ç—Ä–∞–Ω—è–µ—Ç ambiguity

5. –ó–ê–ü–ò–°–¨: obs_builder.pyx:282-285
   ‚îú‚îÄ out_features[11] = macd_signal if macd_signal_valid else 0.0
   ‚îî‚îÄ out_features[12] = 1.0 if macd_signal_valid else 0.0
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Look-ahead bias** | ‚ùå –û–¢–°–£–¢–°–¢–í–£–ï–¢ | - | ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ |
| **Warmup period** | ‚úÖ **35 –±–∞—Ä–æ–≤ (26+9)** | - | ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| **Dependency chain** | ‚úÖ **MACD ‚Üí Signal** | - | ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
| **Fallback overlap** | ‚ö†Ô∏è **0.0 = –Ω–µ—Ç —Å–∏–≥–Ω–∞–ª–∞** | HIGH | ‚úÖ –†–µ—à–µ–Ω–æ —Ñ–ª–∞–≥–æ–º |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å–∫–∞–∂–µ–Ω–∏–π:**

**1. Signal line calculation: –ö–û–†–†–ï–ö–¢–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø** ‚úÖ
- **–§–æ—Ä–º—É–ª–∞** (MarketSimulator.cpp:333, 338-339):
  ```cpp
  const double alpha9 = 2.0 / (9.0 + 1.0);  // 0.2
  double macd = ema12 - ema26;
  v_macd[i] = macd;
  ema9 = ema_step(ema9, macd, alpha9, ema9_init);
  v_macd_signal[i] = ema9;
  ```
- **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è MACD Signal (9-period EMA of MACD)
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å**: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É ‚úÖ

**2. Dependency chain: –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨** ‚úÖ
- **–ü–æ—Ä—è–¥–æ–∫ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π**:
  1. EMA(12) –∏ EMA(26) –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –∏–∑ —Ü–µ–Ω—ã
  2. MACD = EMA(12) - EMA(26)
  3. Signal = EMA(9) of MACD
- **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ ‚Üí look-ahead bias
- **–°—Ç–∞—Ç—É—Å**: –ü–æ—Ä—è–¥–æ–∫ —Å–æ–±–ª—é–¥–µ–Ω ‚úÖ

**3. Warmup period: 35 –ë–ê–†–û–í** ‚úÖ
- MACD –≥–æ—Ç–æ–≤: 26 –±–∞—Ä–æ–≤
- Signal (EMA9 of MACD): –µ—â–µ 9 –±–∞—Ä–æ–≤
- **–ò—Ç–æ–≥–æ**: 26 + 9 = 35 –±–∞—Ä–æ–≤
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å**: –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω–æ

**4. Fallback overlap: –†–ï–®–ï–ù–û –§–õ–ê–ì–û–ú** ‚úÖ
- Signal = 0.0 –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å "—Å–∏–≥–Ω–∞–ª –Ω–∞ –Ω—É–ª–µ–≤–æ–º —É—Ä–æ–≤–Ω–µ"
- Validity flag —Ä–∞–∑–ª–∏—á–∞–µ—Ç "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö" –æ—Ç "—Ä–µ–∞–ª—å–Ω—ã–π –Ω–æ–ª—å"
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

---

### **–ü–†–ò–ó–ù–ê–ö ‚Ññ12: `macd_signal_valid` (–§–ª–∞–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ MACD Signal)**

#### üîç **–ü–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:**

```
1. –ò–°–¢–û–ß–ù–ò–ö: –õ–æ–≥–∏–∫–∞ obs_builder.pyx:281
   ‚îî‚îÄ macd_signal_valid = not isnan(macd_signal)

2. –ó–ê–ü–ò–°–¨: obs_builder.pyx:285
   ‚îî‚îÄ out_features[12] = 1.0 if macd_signal_valid else 0.0
```

#### ‚ö†Ô∏è **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ò–°–ö–ê–ñ–ï–ù–ò–Ø:**

| **–¢–∏–ø –∏—Å–∫–∞–∂–µ–Ω–∏—è** | **–û–ø–∏—Å–∞–Ω–∏–µ** | **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** | **–°—Ç–∞—Ç—É—Å** |
|-------------------|--------------|-----------------|------------|
| **Correctness** | ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞** | - | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |

#### üìù **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

**1. –°–∞–º—ã–π –¥–æ–ª–≥–∏–π warmup period** ‚ö†Ô∏è
- **35 –±–∞—Ä–æ–≤** - —Å–∞–º—ã–π –¥–æ–ª–≥–∏–π warmup —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
- –ü–µ—Ä–≤—ã–µ 35 –±–∞—Ä–æ–≤ —ç–ø–∏–∑–æ–¥–∞: `macd_signal_valid = 0.0`
- –ú–æ–¥–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–∏–≥–Ω–∞–ª "–¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç" –≤ —Ç–µ—á–µ–Ω–∏–µ 140 —á–∞—Å–æ–≤ (35√ó4h)
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å pre-warming –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —ç–ø–∏–∑–æ–¥–∞

**2. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–∂–Ω–æ—Å—Ç—å –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π** ‚úÖ
- MACD crossover (MACD –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç Signal) - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª
- –ë–µ–∑ validity flag: –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –Ω–µ–≥–æ—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –° validity flag: –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨ –Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å**: –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏

---

## üìã **–°–í–û–î–ö–ê –ü–û –≠–¢–ê–ü–£ 2 (–ü—Ä–∏–∑–Ω–∞–∫–∏ 6-12)**

### ‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:**

1. **Wilder's smoothing –¥–ª—è RSI** - —Ç–æ—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—É–ª—ã (Wilder, 1978)
2. **MACD calculation** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è EMA-based —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (Appel, 1979)
3. **Validity flags** - —É—Å—Ç—Ä–∞–Ω—è—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é ambiguity –¥–ª—è fallback –∑–Ω–∞—á–µ–Ω–∏–π
4. **Division by zero protection** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ edge cases (RSI, avg_loss=0)
5. **Dependency chain** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (MACD ‚Üí Signal)
6. **Look-ahead bias** - –û–¢–°–£–¢–°–¢–í–£–ï–¢ –≤–æ –≤—Å–µ—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞—Ö

### ‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **EMA initialization** - –ø–µ—Ä–≤—ã–π –±–∞—Ä –∫–∞–∫ seed (bias –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º)
2. **–î–ª–∏–Ω–Ω—ã–π warmup MACD Signal** - 35 –±–∞—Ä–æ–≤ (140 —á–∞—Å–æ–≤ –Ω–∞ 4h)
3. **Fallback overlap** - 50.0 –¥–ª—è RSI, 0.0 –¥–ª—è MACD (—Ä–µ—à–µ–Ω–æ —Ñ–ª–∞–≥–∞–º–∏)

### üéØ **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**

1. **MEDIUM**: –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å pre-warming –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —ç–ø–∏–∑–æ–¥–∞
   - –ü—Ä–æ–±–ª–µ–º–∞: –ü–µ—Ä–≤—ã–µ 35 –±–∞—Ä–æ–≤ - –≤—Å–µ validity flags = 0.0
   - –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

2. **LOW**: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π EMA initialization (SMA seed –≤–º–µ—Å—Ç–æ first value)
   - –ü—Ä–æ–±–ª–µ–º–∞: Bias –∫ –ø–µ—Ä–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
   - –†–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SMA –ø–µ—Ä–≤—ã—Ö N –±–∞—Ä–æ–≤ –∫–∞–∫ seed

3. **INFO**: –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å warmup periods –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
   - RSI: 14 –±–∞—Ä–æ–≤ (56h)
   - MACD: 26 –±–∞—Ä–æ–≤ (104h)
   - MACD Signal: 35 –±–∞—Ä–æ–≤ (140h)

### üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ warmup periods:**

| –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä | Warmup (–±–∞—Ä—ã) | Warmup (—á–∞—Å—ã) | Validity flag |
|-----------|---------------|---------------|---------------|
| MA5 | 5 | 20h | ‚úÖ ma5_valid |
| MA20 | 21 | 84h | ‚úÖ ma20_valid |
| RSI(14) | 14 | 56h | ‚úÖ rsi_valid |
| MACD | 26 | 104h | ‚úÖ macd_valid |
| MACD Signal | 35 | 140h | ‚úÖ macd_signal_valid |

---

