# –ì–ª—É–±–æ–∫–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã cross-symbol data leakage

## –°—Ç–∞—Ç—É—Å: ‚úÖ –ü–†–û–í–ï–†–ï–ù–û - –ü—Ä–æ–±–ª–µ–º–∞ —á–∞—Å—Ç–∏—á–Ω–æ –õ–û–ñ–ù–ê–Ø

## Executive Summary

–ü–æ—Å–ª–µ –≥–ª—É–±–æ–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã—è—Å–Ω–∏–ª–æ—Å—å:
- ‚ùå **–õ–û–ñ–ù–ê–Ø —Ç—Ä–µ–≤–æ–≥–∞** –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—É—á–µ–Ω–∏—è (train_model_multi_patch.py)
- ‚ö†Ô∏è **–†–ï–ê–õ–¨–ù–ê–Ø –ø—Ä–æ–±–ª–µ–º–∞** –¥–ª—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –ø—É—Ç–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ **–†–ï–ê–õ–¨–ù–ê–Ø –ø—Ä–æ–±–ª–µ–º–∞** –≤ fetch_all_data_patch.py:127

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### 1. –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞–π–ø–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏—è (train_model_multi_patch.py)

#### –ü—É—Ç—å –¥–∞–Ω–Ω—ã—Ö:

```
1. prepare_demo_data.py / prepare_and_run.py
   ‚îî‚îÄ> –°–æ–∑–¥–∞–µ—Ç {symbol}.feather –¥–ª—è –ö–ê–ñ–î–û–ì–û —Å–∏–º–≤–æ–ª–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
   ‚îî‚îÄ> –ù–∞–ø—Ä–∏–º–µ—Ä: BTCUSDT.feather, ETHUSDT.feather

2. fetch_all_data_patch.py:load_all_data()
   ‚îî‚îÄ> for p in feather_paths:  # –¶–∏–∫–ª –ø–æ –∫–∞–∂–¥–æ–º—É —Ñ–∞–π–ª—É
       ‚îî‚îÄ> df = pd.read_feather(p)  # –ß–∏—Ç–∞–µ–º –û–î–ò–ù —Å–∏–º–≤–æ–ª
       ‚îî‚îÄ> df["symbol"] = sym  # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É symbol
       ‚îî‚îÄ> df["close_orig"] = df["close"]  # –°–æ–∑–¥–∞–µ–º close_orig
       ‚îî‚îÄ> df["close_prev"] = df["close_orig"].shift(1)  # ‚ö†Ô∏è Shift –ë–ï–ó groupby
       ‚îî‚îÄ> all_dfs[sym] = df  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–ª–æ–≤–∞—Ä—å

3. train_model_multi_patch.py:4678
   ‚îî‚îÄ> pipe.fit(dfs_with_roles, ...)  # –ü–µ—Ä–µ–¥–∞–µ–º dict[str, DataFrame]

4. features_pipeline.py:160-164
   ‚îî‚îÄ> big = pd.concat(frames, axis=0, ignore_index=True)  # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã
   ‚îî‚îÄ> if "close_orig" in big.columns:  # ‚úÖ –ï–°–¢–¨ close_orig!
           pass  # ‚úÖ Shift –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è!
       elif "close" in big.columns:
           big["close"] = big["close"].shift(1)  # ‚ùå –≠—Ç–æ—Ç –∫–æ–¥ –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è!
```

#### –í—ã–≤–æ–¥:

‚úÖ **–í –æ—Å–Ω–æ–≤–Ω–æ–º –ø–∞–π–ø–ª–∞–π–Ω–µ –æ–±—É—á–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–∞ –û–¢–°–£–¢–°–¢–í–£–ï–¢**, –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. `load_all_data` —Å–æ–∑–¥–∞–µ—Ç `close_orig` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ DataFrame
2. `features_pipeline.fit()` –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç `close_orig` –∏ –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç shift

---

### 2. –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚Ññ1: fetch_all_data_patch.py:127

#### –ö–æ–¥:
```python
df["close_prev"] = df["close_orig"].shift(1)  # –ë–ï–ó groupby!
```

#### –ü—Ä–æ–±–ª–µ–º–∞:

**–ü–û–î–û–ñ–î–ò–¢–ï!** –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –≥–ª—É–±–∂–µ:
- –≠—Ç–æ—Ç –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ `for p in feather_paths:`
- –ö–∞–∂–¥—ã–π .feather —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –û–î–ù–û–ì–û —Å–∏–º–≤–æ–ª–∞
- `shift(1)` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –¥–∞–Ω–Ω—ã–º –û–î–ù–û–ì–û —Å–∏–º–≤–æ–ª–∞

#### –í—ã–≤–æ–¥:

‚úÖ **–¢–£–¢ –ù–ï–¢ –ü–†–û–ë–õ–ï–ú–´**, –ø–æ—Ç–æ–º—É —á—Ç–æ:
- shift –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ö –û–î–ù–û–ú–£ –°–ò–ú–í–û–õ–£ (–≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ –ø–æ —Ñ–∞–π–ª–∞–º)
- –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª = –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª

---

### 3. –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚Ññ2: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### –°—Ü–µ–Ω–∞—Ä–∏–π: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ features_pipeline –ë–ï–ó load_all_data

–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `features_pipeline.py` –Ω–∞–ø—Ä—è–º—É—é —Å –¥–∞–Ω–Ω—ã–º–∏, –≥–¥–µ:
- –ù–ï–¢ –∫–æ–ª–æ–Ω–∫–∏ `close_orig`
- –ï–°–¢–¨ –∫–æ–ª–æ–Ω–∫–∞ `close`
- –î–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –ù–ï–°–ö–û–õ–¨–ö–û —Å–∏–º–≤–æ–ª–æ–≤

–¢–æ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω `shift(1)` –ë–ï–ó groupby:

```python
elif "close" in big.columns:
    big["close"] = big["close"].shift(1)  # ‚ùå –ë–µ–∑ groupby!
```

#### –ü—Ä–∏–º–µ—Ä—ã —Ç–∞–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:

1. **–ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FeaturePipeline.transform_df()**
   - –ö—Ç–æ-—Ç–æ –ø–µ—Ä–µ–¥–∞–µ—Ç DataFrame —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏
   - –ë–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ load_all_data

2. **–¢–µ—Å—Ç—ã –∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã**
   - –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ close_orig

---

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞

### ‚úÖ –î–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞:

**–ü—Ä–æ–±–ª–µ–º–∞ –û–¢–°–£–¢–°–¢–í–£–ï–¢** –±–ª–∞–≥–æ–¥–∞—Ä—è:
1. –ö–∞–∂–¥—ã–π .feather —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª
2. load_all_data —Å–æ–∑–¥–∞–µ—Ç close_orig
3. features_pipeline.fit() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç close_orig

### ‚ö†Ô∏è –î–ª—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –ø—É—Ç–µ–π:

**–ü—Ä–æ–±–ª–µ–º–∞ –ü–†–ò–°–£–¢–°–¢–í–£–ï–¢**, –µ—Å–ª–∏:
- –î–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—è—Ç—Å—è –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º
- –ù–ï–¢ close_orig –≤ –¥–∞–Ω–Ω—ã—Ö
- –ù–µ—Å–∫–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª–æ–≤ –≤ –æ–¥–Ω–æ–º DataFrame

### üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

#### 1. Defensive Programming –≤ features_pipeline.py

–î–∞–∂–µ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è, –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ó–ê–©–ò–©–ï–ù:

```python
# features_pipeline.py:160-165
big = pd.concat(frames, axis=0, ignore_index=True)
if "close_orig" in big.columns:
    pass
elif "close" in big.columns:
    # DEFENSIVE: Always use groupby if symbol column exists
    if "symbol" in big.columns:
        big["close"] = big.groupby("symbol")["close"].shift(1)
    else:
        big["close"] = big["close"].shift(1)
```

#### 2. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è transform_df:

```python
# features_pipeline.py:207-215
def transform_df(self, df: pd.DataFrame, add_suffix: str = "_z") -> pd.DataFrame:
    if not self.stats:
        raise ValueError("FeaturePipeline is empty; call fit() or load().")
    out = df.copy()
    if "close_orig" in out.columns:
        pass
    elif "close" in out.columns:
        # DEFENSIVE: Always use groupby if symbol column exists
        if "symbol" in out.columns:
            out["close"] = out.groupby("symbol")["close"].shift(1)
        else:
            out["close"] = out["close"].shift(1)
```

---

## –ó–∞—á–µ–º –≤–æ–æ–±—â–µ –Ω—É–∂–µ–Ω shift –¥–ª—è close?

### –ê–Ω–∞–ª–∏–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:

```python
# fetch_all_data_patch.py:124-127
# –ù–µ –ª–æ–º–∞–µ–º OHLC: –æ—Å—Ç–∞–≤–ª—è–µ–º close –∫–∞–∫ –µ—Å—Ç—å, –∞ ¬´–ø—Ä–æ—à–ª—ã–π close¬ª –∫–ª–∞–¥—ë–º –æ—Ç–¥–µ–ª—å–Ω–æ
if "close" in df.columns:
    df["close_orig"] = df["close"].astype(float)
    df["close_prev"] = df["close_orig"].shift(1)  # –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ –≤ —Ñ–∏—á–∞—Ö –≤–º–µ—Å—Ç–æ —Å–¥–≤–∏–≥–∞ —Å–∞–º–æ–≥–æ close
```

### –ì–∏–ø–æ—Ç–µ–∑–∞:

–í–æ–∑–º–æ–∂–Ω–æ, –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ –±—ã–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ–º, —á—Ç–æ:
1. –ü—Ä–∏–∑–Ω–∞–∫–∏ (features) –Ω—É–∂–¥–∞–ª–∏—Å—å –≤ "–ø—Ä–æ—à–ª–æ–π" —Ü–µ–Ω–µ –∑–∞–∫—Ä—ã—Ç–∏—è
2. –ù–æ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–∞–º–æ–π –∫–æ–ª–æ–Ω–∫–∏ "close" –ª–æ–º–∞–ª–∞ OHLCV –¥–∞–Ω–Ω—ã–µ
3. –ü–æ—ç—Ç–æ–º—É —Å–æ–∑–¥–∞–ª–∏ close_orig (–Ω–µ–∏–∑–º–µ–Ω–Ω–∞—è –∫–æ–ø–∏—è) –∏ close_prev (—Å–¥–≤–∏–Ω—É—Ç–∞—è –≤–µ—Ä—Å–∏—è)

### –ù–û –≤ features_pipeline:

–ö–æ–¥ –ü–´–¢–ê–ï–¢–°–Ø —Å–¥–≤–∏–Ω—É—Ç—å —Å–∞–º—É –∫–æ–ª–æ–Ω–∫—É "close" –µ—Å–ª–∏ –Ω–µ—Ç close_orig. –≠—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —Ñ–∏–ª–æ—Å–æ—Ñ–∏–∏ "–Ω–µ –ª–æ–º–∞—Ç—å OHLC".

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

‚úÖ **–ë–ï–ó–û–ü–ê–°–ù–û** - –ø—Ä–æ–±–ª–µ–º–∞ –ù–ï –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–∞–π–ø–ª–∞–π–Ω–µ

### –î–ª—è –±—É–¥—É—â–µ–≥–æ / –¥—Ä—É–≥–∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:

‚ö†Ô∏è **–£–Ø–ó–í–ò–ú–û** - –∫–æ–¥ –Ω–µ –∑–∞—â–∏—â–µ–Ω –æ—Ç cross-symbol leakage

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:

**–ò–°–ü–†–ê–í–ò–¢–¨ –ö–û–î** –¥–ª—è defensive programming, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è —Å–µ–π—á–∞—Å.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°–†–ï–î–ù–ò–ô (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞)

---

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á–µ—Ç `CRITICAL_CROSS_SYMBOL_DATA_LEAKAGE.md` —Å–æ–¥–µ—Ä–∂–∞–ª:
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û–ô –ø—Ä–æ–±–ª–µ–º—ã
- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –¥–ª—è –¢–ï–ö–£–©–ï–ì–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é (defensive programming)

**–°—Ç–∞—Ç—É—Å:** –°–ª–µ–¥—É–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—á–µ—Ç —Å —É—Ç–æ—á–Ω–µ–Ω–∏—è–º–∏.
