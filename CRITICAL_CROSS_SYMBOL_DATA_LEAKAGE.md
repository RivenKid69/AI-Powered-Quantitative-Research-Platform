# –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Å–∏–º–≤–æ–ª–∞–º–∏ –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

## –°—Ç–∞—Ç—É—Å: üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê**

## Executive Summary

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞**: –æ–ø–µ—Ä–∞—Ü–∏—è `shift(1)` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ë–ï–ó –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ —Å–∏–º–≤–æ–ª–∞–º, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —É—Ç–µ—á–∫–µ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —Ç–æ—Ä–≥–æ–≤—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏.

**–í–ª–∏—è–Ω–∏–µ**:
- ‚ùå –î–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ü–µ–Ω–∞ –ü–†–ï–î–´–î–£–©–ï–ì–û —Å–∏–º–≤–æ–ª–∞
- ‚ùå –ò—Å–∫–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ (mean/std)
- ‚ùå –ù–∞—Ä—É—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
- ‚ùå –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ—Ä—è–¥–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å**: **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø** - —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö

---

## –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏

#### features_pipeline.py:160-165 (–º–µ—Ç–æ–¥ fit)
```python
big = pd.concat(frames, axis=0, ignore_index=True)
if "close_orig" in big.columns:
    pass
elif "close" in big.columns:
    big["close"] = big["close"].shift(1)  # ‚ùå –ù–ï–¢ groupby("symbol")!
```

#### features_pipeline.py:207-215 (–º–µ—Ç–æ–¥ transform_df)
```python
def transform_df(self, df: pd.DataFrame, add_suffix: str = "_z") -> pd.DataFrame:
    if not self.stats:
        raise ValueError("FeaturePipeline is empty; call fit() or load().")
    out = df.copy()
    if "close_orig" in out.columns:
        pass
    elif "close" in out.columns:
        out["close"] = out["close"].shift(1)  # ‚ùå –ù–ï–¢ groupby("symbol")!
```

#### fetch_all_data_patch.py:126-127
```python
if "close" in df.columns:
    df["close_orig"] = df["close"].astype(float)
    df["close_prev"] = df["close_orig"].shift(1)  # ‚ùå –ù–ï–¢ groupby("symbol")!
```

### 2. –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –≤ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–∞—Ö

–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç—è—Ö –∫–æ–¥–∞–±–∞–∑—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `groupby`:

#### feature_pipe.py:839 ‚úÖ
```python
future_price = df.groupby("symbol")[self.price_col].shift(-1)
```

#### service_calibrate_tcost.py:43 ‚úÖ
```python
prev = df.groupby(sym_col)[price_col].shift(1)
```

#### trainingtcost.py:108 ‚úÖ
```python
future_price = df.groupby(symbol_col)[ref_price_col].shift(-int(horizon_bars))
```

### 3. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º—ã

#### –°—Ü–µ–Ω–∞—Ä–∏–π: 2 —Å–∏–º–≤–æ–ª–∞, 3 –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–æ—á–∫–∏ –∫–∞–∂–¥—ã–π

```python
# –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
symbol    timestamp    close
BTCUSDT   1000         100.0
BTCUSDT   2000         101.0
BTCUSDT   3000         102.0
ETHUSDT   1000         200.0
ETHUSDT   2000         202.0
ETHUSDT   3000         204.0
```

#### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (—Ç–µ–∫—É—â–∏–π –∫–æ–¥):
```python
df["close"] = df["close"].shift(1)

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
symbol    timestamp    close    close_shifted
BTCUSDT   1000         100.0    NaN           ‚úì OK
BTCUSDT   2000         101.0    100.0         ‚úì OK (–ø—Ä–µ–¥—ã–¥—É—â–∏–π BTCUSDT)
BTCUSDT   3000         102.0    101.0         ‚úì OK (–ø—Ä–µ–¥—ã–¥—É—â–∏–π BTCUSDT)
ETHUSDT   1000         200.0    102.0         ‚ùå –û–®–ò–ë–ö–ê! (—ç—Ç–æ BTCUSDT!)
ETHUSDT   2000         202.0    200.0         ‚úì OK (–ø—Ä–µ–¥—ã–¥—É—â–∏–π ETHUSDT)
ETHUSDT   3000         204.0    202.0         ‚úì OK (–ø—Ä–µ–¥—ã–¥—É—â–∏–π ETHUSDT)
```

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (—Å groupby):
```python
df["close_shifted"] = df.groupby("symbol")["close"].shift(1)

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
symbol    timestamp    close    close_shifted
BTCUSDT   1000         100.0    NaN           ‚úì OK
BTCUSDT   2000         101.0    100.0         ‚úì OK (–ø—Ä–µ–¥—ã–¥—É—â–∏–π BTCUSDT)
BTCUSDT   3000         102.0    101.0         ‚úì OK (–ø—Ä–µ–¥—ã–¥—É—â–∏–π BTCUSDT)
ETHUSDT   1000         200.0    NaN           ‚úì OK (–Ω–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ ETHUSDT)
ETHUSDT   2000         202.0    200.0         ‚úì OK (–ø—Ä–µ–¥—ã–¥—É—â–∏–π ETHUSDT)
ETHUSDT   3000         204.0    202.0         ‚úì OK (–ø—Ä–µ–¥—ã–¥—É—â–∏–π ETHUSDT)
```

---

## –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –æ—à–∏–±–∫–∏

### 1. ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: –ò—Å–∫–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

–í `features_pipeline.fit()` —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (mean/std) —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

```python
# features_pipeline.py:166-175
cols = _columns_to_scale(big)
stats = {}
for c in cols:
    v = big[c].astype(float).to_numpy()
    m = float(np.nanmean(v))  # ‚Üê mean —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö!
    s = float(np.nanstd(v, ddof=0))  # ‚Üê std —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö!
```

**–ü—Ä–∏–º–µ—Ä –≤–ª–∏—è–Ω–∏—è:**
- –ï—Å–ª–∏ `BTCUSDT close=100`, `ETHUSDT close=200`
- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ETHUSDT –ø–æ–ª—É—á–∞–µ—Ç `close_shifted=102` (–ø–æ—Å–ª–µ–¥–Ω–∏–π BTCUSDT)
- –í–º–µ—Å—Ç–æ `close_shifted=NaN`
- Mean –∏ Std –±—É–¥—É—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–ª—è ETHUSDT

### 2. ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: –£—Ç–µ—á–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–µ–∂–¥—É —Å–∏–º–≤–æ–ª–∞–º–∏

–ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –∫–æ—Å–≤–µ–Ω–Ω–æ "–≤–∏–¥–µ—Ç—å" –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥—Ä—É–≥–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö —á–µ—Ä–µ–∑ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–Ω—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é.

### 3. ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:
- –ü–æ—Ä—è–¥–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ –≤ `pd.concat(frames, axis=0, ignore_index=True)`
- –ü–æ—Ä—è–¥–∫–∞ —Å—Ç—Ä–æ–∫ –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ
- –≠—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å

### 4. ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û: Train/Inference mismatch

–ï—Å–ª–∏ –≤ inference —Å–∏–º–≤–æ–ª—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –¥—Ä—É–≥–æ–º –ø–æ—Ä—è–¥–∫–µ, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –±—É–¥–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π.

---

## –û—Ü–µ–Ω–∫–∞ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏

1. **–ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è**: 100% (–≤—Å–µ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Å–∏–º–≤–æ–ª–∞)
2. **–í–ª–∏—è–Ω–∏–µ –Ω–∞ –º–æ–¥–µ–ª—å**: –í—ã—Å–æ–∫–æ–µ (–∏—Å–∫–∞–∂–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏)
3. **–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ–º–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è (–º–æ–ª—á–∞–ª–∏–≤–æ–µ –∏—Å–∫–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)
4. **–ú–∞—Å—à—Ç–∞–±**: –ì–ª–æ–±–∞–ª—å–Ω—ã–π (–∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –≤—Å–µ –æ–±—É—á–µ–Ω–∏–µ)

### –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: üî¥ CRITICAL

- ‚úÖ –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–µ
- ‚úÖ –ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –≤—Å–µ –º–æ–¥–µ–ª–∏
- ‚úÖ –ò—Å–∫–∞–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è
- ‚úÖ –ù–∞—Ä—É—à–∞–µ—Ç best practices –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é

### –†–µ—à–µ–Ω–∏–µ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å features_pipeline.py (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

#### features_pipeline.py:160-165
```python
# BEFORE (BROKEN):
big = pd.concat(frames, axis=0, ignore_index=True)
if "close_orig" in big.columns:
    pass
elif "close" in big.columns:
    big["close"] = big["close"].shift(1)

# AFTER (FIXED):
big = pd.concat(frames, axis=0, ignore_index=True)
if "close_orig" in big.columns:
    pass
elif "close" in big.columns:
    # CRITICAL FIX: Use groupby to prevent cross-symbol data leakage
    # Without groupby, first row of each symbol gets previous symbol's close price
    if "symbol" in big.columns:
        big["close"] = big.groupby("symbol")["close"].shift(1)
    else:
        # Fallback if no symbol column (single-symbol dataset)
        big["close"] = big["close"].shift(1)
```

#### features_pipeline.py:207-215
```python
# BEFORE (BROKEN):
def transform_df(self, df: pd.DataFrame, add_suffix: str = "_z") -> pd.DataFrame:
    if not self.stats:
        raise ValueError("FeaturePipeline is empty; call fit() or load().")
    out = df.copy()
    if "close_orig" in out.columns:
        pass
    elif "close" in out.columns:
        out["close"] = out["close"].shift(1)

# AFTER (FIXED):
def transform_df(self, df: pd.DataFrame, add_suffix: str = "_z") -> pd.DataFrame:
    if not self.stats:
        raise ValueError("FeaturePipeline is empty; call fit() or load().")
    out = df.copy()
    if "close_orig" in out.columns:
        pass
    elif "close" in out.columns:
        # CRITICAL FIX: Use groupby to prevent cross-symbol data leakage
        if "symbol" in out.columns:
            out["close"] = out.groupby("symbol")["close"].shift(1)
        else:
            # Fallback if no symbol column (single-symbol dataset)
            out["close"] = out["close"].shift(1)
```

### –†–µ—à–µ–Ω–∏–µ 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å fetch_all_data_patch.py

#### fetch_all_data_patch.py:126-127
```python
# BEFORE (BROKEN):
if "close" in df.columns:
    df["close_orig"] = df["close"].astype(float)
    df["close_prev"] = df["close_orig"].shift(1)

# AFTER (FIXED):
if "close" in df.columns:
    df["close_orig"] = df["close"].astype(float)
    # CRITICAL FIX: Use groupby to prevent cross-symbol data leakage
    if "symbol" in df.columns:
        df["close_prev"] = df.groupby("symbol")["close_orig"].shift(1)
    else:
        df["close_prev"] = df["close_orig"].shift(1)
```

### –†–µ—à–µ–Ω–∏–µ 3: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å close_orig –≤–µ–∑–¥–µ

**–í–æ–ø—Ä–æ—Å**: –ó–∞—á–µ–º –≤–æ–æ–±—â–µ –Ω—É–∂–µ–Ω shift –¥–ª—è close?

**–ê–Ω–∞–ª–∏–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:**
```python
# fetch_all_data_patch.py:124-127
# –ù–µ –ª–æ–º–∞–µ–º OHLC: –æ—Å—Ç–∞–≤–ª—è–µ–º close –∫–∞–∫ –µ—Å—Ç—å, –∞ ¬´–ø—Ä–æ—à–ª—ã–π close¬ª –∫–ª–∞–¥—ë–º –æ—Ç–¥–µ–ª—å–Ω–æ
if "close" in df.columns:
    df["close_orig"] = df["close"].astype(float)
    df["close_prev"] = df["close_orig"].shift(1)  # –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ –≤ —Ñ–∏—á–∞—Ö –≤–º–µ—Å—Ç–æ —Å–¥–≤–∏–≥–∞ —Å–∞–º–æ–≥–æ close
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ï—Å–ª–∏ –µ—Å—Ç—å `close_orig`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤–º–µ—Å—Ç–æ shift. –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–∏–º–µ–Ω—è—Ç—å shift —Å groupby.

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢—Ä–µ–±—É–µ–º—ã–µ —Ç–µ—Å—Ç—ã

1. **Unit test**: –ü—Ä–æ–≤–µ—Ä–∫–∞ shift —Å groupby
```python
def test_features_pipeline_shift_respects_symbol_boundaries():
    """Test that shift(1) is applied per-symbol, not globally."""
    data = pd.DataFrame({
        'symbol': ['BTC', 'BTC', 'ETH', 'ETH'],
        'timestamp': [1000, 2000, 1000, 2000],
        'close': [100.0, 101.0, 200.0, 202.0]
    })

    pipe = FeaturePipeline()
    # ... fit and transform ...

    # First row of ETH should have NaN, NOT last BTC value
    eth_first = result[result['symbol'] == 'ETH'].iloc[0]
    assert pd.isna(eth_first['close']) or eth_first['close'] != 101.0
```

2. **Integration test**: End-to-end –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
3. **Edge case**: –û–¥–∏–Ω —Å–∏–º–≤–æ–ª (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ groupby)
4. **Edge case**: –ú–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–ª—è—Ü–∏–∏)

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `features_pipeline.py:160-165` - fit() –º–µ—Ç–æ–¥
- `features_pipeline.py:207-215` - transform_df() –º–µ—Ç–æ–¥
- `fetch_all_data_patch.py:126-127` - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- `feature_pipe.py:839` - –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø—Ä–∏–º–µ—Ä —Å groupby
- `service_calibrate_tcost.py:43` - –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø—Ä–∏–º–µ—Ä —Å groupby
- `trainingtcost.py:108` - –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø—Ä–∏–º–µ—Ä —Å groupby

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
2. ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
3. ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
4. ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –ø–∞–π–ø–ª–∞–π–Ω–æ–º
5. ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–µ–ª–∏

---

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô - —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**

–≠—Ç–∞ –æ—à–∏–±–∫–∞ —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –∏ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –≤—Å–µ –æ–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏. –í—Å–µ –º–æ–¥–µ–ª–∏, –æ–±—É—á–µ–Ω–Ω—ã–µ —Å —Ç–µ–∫—É—â–∏–º –∫–æ–¥–æ–º, –º–æ–≥—É—Ç –∏–º–µ—Ç—å –∏—Å–∫–∞–∂–µ–Ω–Ω—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –∏ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.

---

## –ü–æ—á–µ–º—É —ç—Ç–æ –Ω–µ –±—ã–ª–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä–∞–Ω–µ–µ?

1. **–ú–æ–ª—á–∞–ª–∏–≤–æ–µ –∏—Å–∫–∞–∂–µ–Ω–∏–µ**: –ö–æ–¥ –Ω–µ –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π
2. **–ß–∞—Å—Ç–∏—á–Ω–∞—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Å–∏–º–≤–æ–ª–∞)
3. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ø–æ—Ä—è–¥–∫–∞**: –ü—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∑–∞–º–µ—Ç–Ω–∞ –µ—Å–ª–∏ —Å–∏–º–≤–æ–ª–æ–≤ –º–∞–ª–æ –∏–ª–∏ –æ–Ω–∏ —É–ø–æ—Ä—è–¥–æ—á–µ–Ω—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤**: –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏—Ö –∏–∑–æ–ª—è—Ü–∏—é –º–µ–∂–¥—É —Å–∏–º–≤–æ–ª–∞–º–∏

---

## –í—ã–≤–æ–¥—ã

1. **–ü—Ä–æ–±–ª–µ–º–∞ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø**: –§—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö
2. **–í–ª–∏—è–Ω–∏–µ –ì–õ–û–ë–ê–õ–¨–ù–û–ï**: –ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –≤—Å–µ –º–æ–¥–µ–ª–∏, –æ–±—É—á–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ features_pipeline.py
3. **–†–µ—à–µ–Ω–∏–µ –ü–†–û–°–¢–û–ï**: –î–æ–±–∞–≤–∏—Ç—å `groupby("symbol")` –ø–µ—Ä–µ–¥ `shift(1)`
4. **–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è **–¢–†–ï–ë–£–ï–¢ –ù–ï–ú–ï–î–õ–ï–ù–ù–û–ì–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**
