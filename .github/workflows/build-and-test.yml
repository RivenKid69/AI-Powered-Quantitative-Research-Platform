name: Build and Test

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  build:
    name: Build, verify hash, and test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PYTHONDONTWRITEBYTECODE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install make (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: choco install make --yes

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies (CPU, build, dev)
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-build.txt
          python -m pip install -r requirements-cpu.lock.txt
          python -m pip install -r requirements-dev.txt

      - name: Enforce generated-file policy before build
        run: python tools/clean_artifacts.py --check-only

      - name: Build
        run: make build

      - name: Verify build hash report
        run: make verify-hash

      - name: Run test suite
        run: make test

      - name: Clean artifacts
        run: make clean

      - name: Ensure worktree is clean after clean
        run: |
          make check-clean
          python -c "import subprocess, sys; s=subprocess.check_output(['git','status','--porcelain']).decode().strip(); print(s) if s else None; sys.exit(1 if s else 0)"
