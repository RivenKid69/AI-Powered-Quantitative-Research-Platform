name: Build and Test

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  build:
    name: Build, verify hash, and test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PYTHONDONTWRITEBYTECODE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install make (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: choco install make --yes

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies (CPU, build, dev)
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements-build.txt
          python -m pip install -r requirements-cpu.lock.txt
          python -m pip install -r requirements-dev.txt

      - name: Lint with ruff
        run: python -m ruff check .

      - name: Check formatting with black
        run: python -m black --check .

      - name: Lint imports (soft)
        continue-on-error: true
        env:
          PYTHONUTF8: "1"
        run: lint-imports --config importlinter.ini --show-timings

      - name: Lint imports (enforced)
        env:
          PYTHONUTF8: "1"
        run: lint-imports --config importlinter.ini --show-timings

      - name: Detect secrets (soft)
        continue-on-error: true
        env:
          PYTHONUTF8: "1"
        run: python -m detect_secrets scan --baseline .secrets.baseline --all-files --json > detect-secrets-scan.json

      - name: Detect secrets (enforced)
        env:
          PYTHONUTF8: "1"
        run: |
          python - <<'PY'
          import json, subprocess, sys, pathlib

          cmd = [
              sys.executable,
              "-m",
              "detect_secrets",
              "scan",
              "--baseline",
              ".secrets.baseline",
              "--all-files",
              "--json",
          ]
          result = subprocess.run(cmd, capture_output=True, text=True)
          pathlib.Path("detect-secrets-scan.json").write_text(result.stdout, encoding="utf-8")
          if result.returncode not in (0,):
              sys.stdout.write(result.stdout)
              sys.stderr.write(result.stderr)
              sys.exit(result.returncode)

          baseline = json.loads(pathlib.Path(".secrets.baseline").read_text(encoding="utf-8"))
          scan = json.loads(result.stdout or "{}")
          baseline_hashes = {
              fname: {finding["hashed_secret"] for finding in findings}
              for fname, findings in baseline.get("results", {}).items()
          }
          new = []
          for fname, findings in scan.get("results", {}).items():
              allowed = baseline_hashes.get(fname, set())
              for finding in findings:
                  if finding.get("hashed_secret") not in allowed:
                      new.append(f"{fname}:{finding.get('line_number')} ({finding.get('type')})")

          if new:
              print("New potential secrets detected (not in baseline):")
              for item in new:
                  print(f"- {item}")
              sys.exit(1)
          PY

      - name: Enforce generated-file policy before build
        run: python tools/clean_artifacts.py --check-only

      - name: Build
        run: make build

      - name: Verify build hash report
        run: make verify-hash

      - name: Run test suite
        run: make test

      - name: Clean artifacts
        run: make clean

      - name: Ensure worktree is clean after clean
        run: |
          make check-clean
          python -c "import subprocess, sys; s=subprocess.check_output(['git','status','--porcelain']).decode().strip(); print(s) if s else None; sys.exit(1 if s else 0)"
