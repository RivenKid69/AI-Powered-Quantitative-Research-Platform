name: Security SAST Analysis

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  bandit:
    name: Bandit Security Scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit (fail on MEDIUM+)
        run: |
          set -euo pipefail
          set +e
          bandit -c .bandit -r . --severity-level medium --confidence-level medium -f json -o bandit-results.json
          status_json=$?
          bandit -c .bandit -r . --severity-level medium --confidence-level medium -f txt -o bandit-results.txt
          status_txt=$?
          set -e
          if [ "$status_json" -ge 2 ] || [ "$status_txt" -ge 2 ]; then
            echo "::error::Bandit execution failed (json=$status_json, txt=$status_txt)"
            exit 2
          fi
          echo "=== Bandit MEDIUM+ findings ==="
          cat bandit-results.txt || true
          python - <<'PY'
          import json, sys
          data = json.load(open("bandit-results.json", "r", encoding="utf-8"))
          findings = [
              r for r in data.get("results", [])
              if str(r.get("issue_severity", "")).lower() in {"medium", "high"}
          ]
          if findings:
              print(f"Found {len(findings)} Bandit issues with medium+ severity")
              sys.exit(1)
          PY

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-results
          path: |
            bandit-results.json
            bandit-results.txt
          retention-days: 30

  semgrep:
    name: Semgrep Security Scanner
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep scan
        run: |
          set -euo pipefail
          set +e
          semgrep scan --config .semgrep.yml --config p/python --config p/secrets --json --output semgrep-results.json --metrics=off
          status=$?
          set -e
          if [ "$status" -ge 2 ]; then
            echo "::error::Semgrep failed with exit code $status"
            exit $status
          fi
          python - <<'PY'
          import json, sys
          data = json.load(open("semgrep-results.json", "r", encoding="utf-8"))
          errors = [
              r for r in data.get("results", [])
              if str(r.get("extra", {}).get("severity", "")).lower() in {"error", "critical"}
          ]
          print(f"Semgrep ERROR/CRITICAL findings: {len(errors)}")
          if errors:
              sys.exit(1)
          PY

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: semgrep-results.json
          retention-days: 30

  secrets-scan:
    name: Secret Scanners
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install gitleaks
        run: |
          set -euo pipefail
          curl -sSL https://raw.githubusercontent.com/gitleaks/gitleaks/master/install.sh | bash -s -- -b /usr/local/bin

      - name: Run gitleaks
        id: gitleaks
        run: |
          set +e
          gitleaks detect --no-git --report-format json --report-path gitleaks-report.json
          status=$?
          set -e
          echo "exit_code=$status" >> "$GITHUB_OUTPUT"

      - name: Install trufflehog
        run: pip install --upgrade trufflehog

      - name: Run trufflehog
        id: trufflehog
        run: |
          set +e
          trufflehog filesystem --no-update --json . > trufflehog-report.json
          status=$?
          set -e
          echo "exit_code=$status" >> "$GITHUB_OUTPUT"

      - name: Enforce secret scan results
        run: |
          set -euo pipefail
          gitleaks_status="${{ steps.gitleaks.outputs.exit_code }}"
          trufflehog_status="${{ steps.trufflehog.outputs.exit_code }}"
          gitleaks_status=${gitleaks_status:-0}
          trufflehog_status=${trufflehog_status:-0}
          fail=0
          if [ "$gitleaks_status" != "0" ]; then
            echo "::error::gitleaks detected potential secrets (exit=$gitleaks_status)"
            fail=1
          fi
          if [ "$trufflehog_status" != "0" ]; then
            echo "::error::trufflehog detected potential secrets (exit=$trufflehog_status)"
            fail=1
          fi
          if [ "$fail" -ne 0 ]; then
            exit 1
          fi

      - name: Upload secret scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-scan-results
          path: |
            gitleaks-report.json
            trufflehog-report.json
          retention-days: 30
          if-no-files-found: ignore

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependency audit tooling
        run: pip install --upgrade pip-audit safety cyclonedx-bom

      - name: Run pip-audit on lockfiles
        run: |
          set -euo pipefail
          files=()
          for f in requirements-cpu.lock.txt requirements-gpu.lock.txt requirements-dev.txt requirements-build.txt; do
            if [ -f "$f" ]; then
              files+=("$f")
            fi
          done
          if [ ${#files[@]} -eq 0 ]; then
            echo "No lockfiles found"
            exit 0
          fi
          for file in "${files[@]}"; do
            out="pip-audit-${file//[^A-Za-z0-9]/_}.json"
            set +e
            pip-audit -r "$file" --format json --output "$out" --disable-pip --progress-spinner off
            status=$?
            set -e
            if [ "$status" -ge 2 ]; then
              echo "::error::pip-audit failed for $file (exit=$status)"
              exit $status
            fi
          done
          python - <<'PY'
          import glob, json, sys
          high = 0
          for path in glob.glob("pip-audit-*.json"):
              data = json.load(open(path, "r", encoding="utf-8"))
              for dep in data:
                  for vuln in dep.get("vulns", []):
                      sev = str(vuln.get("severity", "")).upper()
                      if sev in {"HIGH", "CRITICAL"}:
                          high += 1
          if high:
              print(f"pip-audit found {high} HIGH/CRITICAL vulnerabilities")
              sys.exit(1)
          PY

      - name: Run safety on lockfiles
        run: |
          set -euo pipefail
          files=()
          for f in requirements-cpu.lock.txt requirements-gpu.lock.txt requirements-dev.txt requirements-build.txt; do
            if [ -f "$f" ]; then
              files+=("$f")
            fi
          done
          if [ ${#files[@]} -eq 0 ]; then
            echo "No lockfiles found for safety"
            exit 0
          fi
          for file in "${files[@]}"; do
            out="safety-${file//[^A-Za-z0-9]/_}.json"
            set +e
            safety check --file "$file" --json > "$out"
            status=$?
            set -e
            if [ "$status" -ge 2 ]; then
              echo "::error::safety failed for $file (exit=$status)"
              exit $status
            fi
          done
          python - <<'PY'
          import glob, json, sys
          high = 0
          for path in glob.glob("safety-*.json"):
              try:
                  payload = json.load(open(path, "r", encoding="utf-8"))
              except json.JSONDecodeError:
                  continue
              vulns = payload.get("vulnerabilities") or payload.get("issues") or []
              for vuln in vulns:
                  sev = str(vuln.get("severity", "")).upper()
                  if not sev and isinstance(vuln, dict):
                      sev = str(vuln.get("severity", vuln.get("severity_level", ""))).upper()
                  if sev in {"HIGH", "CRITICAL"}:
                      high += 1
          if high:
              print(f"Safety reported {high} HIGH/CRITICAL vulnerabilities")
              sys.exit(1)
          PY

      - name: Generate SBOM (CycloneDX)
        run: |
          set -euo pipefail
          files=()
          for f in requirements-cpu.lock.txt requirements-gpu.lock.txt requirements-dev.txt requirements-build.txt; do
            if [ -f "$f" ]; then
              files+=("$f")
            fi
          done
          if [ ${#files[@]} -eq 0 ]; then
            echo "No lockfiles found for SBOM generation"
            exit 0
          fi
          args=""
          for file in "${files[@]}"; do
            args="$args --requirements $file"
          done
          cyclonedx-py --format json --output sbom.json $args

      - name: Upload dependency audit artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit
          path: |
            pip-audit-*.json
            safety-*.json
            sbom.json
          if-no-files-found: ignore
          retention-days: 30

  summary:
    name: Security Summary
    needs: [bandit, semgrep, secrets-scan, dependency-audit]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Security Scan Summary:"
          echo "  - Bandit: ${{ needs.bandit.result }}"
          echo "  - Semgrep: ${{ needs.semgrep.result }}"
          echo "  - Secret Scans: ${{ needs.secrets-scan.result }}"
          echo "  - Dependency Audit: ${{ needs.dependency-audit.result }}"
          if [ "${{ needs.bandit.result }}" == "failure" ] || [ "${{ needs.semgrep.result }}" == "failure" ] || [ "${{ needs.secrets-scan.result }}" == "failure" ] || [ "${{ needs.dependency-audit.result }}" == "failure" ]; then
            echo "❌ Security checks failed"
            exit 1
          fi
          echo "✅ Security checks passed"
