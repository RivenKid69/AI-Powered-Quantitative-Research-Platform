# =============================================================================
# FOREX DEFAULTS CONFIGURATION v2.0
# =============================================================================
#
# Comprehensive configuration for Forex trading integration.
# Unlike crypto (centralized LOB) or equity (exchange LOB), Forex is an
# OTC (Over-The-Counter) market with dealer quotes.
#
# This file provides:
#   - Default settings for forex asset class
#   - Session-aware trading configuration
#   - Spread-based fee structure
#   - L2+ Parametric TCA model settings
#   - OTC Dealer simulation parameters
#   - Leverage and margin settings
#   - Position sync configuration
#   - Data source mappings
#
# Key Differences from Crypto/Equity:
#   - Trading hours: Sun 5pm - Fri 5pm ET (24/5)
#   - Fees: Spread-based (no maker/taker commission)
#   - Execution: OTC dealer quotes with last-look
#   - Leverage: 50:1 to 500:1 (vs 1-4x for equity)
#   - Settlement: Rolling spot (T+2 for delivery)
#
# References:
#   - BIS Triennial Survey (2022): FX Market Structure
#   - CFTC Leverage Rules: Retail forex limits
#   - NFA Forex Requirements: US regulations
#   - OANDA API Documentation
#
# =============================================================================

forex:
  # ---------------------------------------------------------------------------
  # Core Settings
  # ---------------------------------------------------------------------------
  asset_class: forex
  data_vendor: oanda           # oanda, ig, dukascopy
  market: spot                 # spot, forward, swap

  # ---------------------------------------------------------------------------
  # Trading Hours (DST-aware)
  # ---------------------------------------------------------------------------
  # Forex trades 24/5: Sunday 5pm ET to Friday 5pm ET
  # Major sessions overlap for maximum liquidity
  session:
    calendar: forex_24x5       # Custom forex calendar
    weekend_filter: true       # Filter out weekend gaps
    rollover_time_et: 17       # 5pm ET (constant regardless of DST)
    rollover_keepout_minutes: 30  # Avoid trading around rollover
    dst_aware: true            # Adjust session times for DST

    # Session definitions (UTC hours)
    sessions:
      sydney:
        start_utc: 21          # 21:00 UTC (previous day)
        end_utc: 6             # 06:00 UTC
        liquidity_factor: 0.65
        spread_multiplier: 1.50
      tokyo:
        start_utc: 0           # 00:00 UTC
        end_utc: 9             # 09:00 UTC
        liquidity_factor: 0.75
        spread_multiplier: 1.30
      london:
        start_utc: 7           # 07:00 UTC
        end_utc: 16            # 16:00 UTC
        liquidity_factor: 1.10
        spread_multiplier: 1.00
      new_york:
        start_utc: 12          # 12:00 UTC
        end_utc: 21            # 21:00 UTC
        liquidity_factor: 1.05
        spread_multiplier: 1.00

    # High liquidity overlaps
    overlaps:
      london_ny:
        start_utc: 12
        end_utc: 16
        liquidity_factor: 1.40
        spread_multiplier: 0.80  # Tightest spreads
      tokyo_london:
        start_utc: 7
        end_utc: 9
        liquidity_factor: 0.90
        spread_multiplier: 1.10

  # ---------------------------------------------------------------------------
  # Fees: Spread-based (No Commission)
  # ---------------------------------------------------------------------------
  # Forex brokers make money on spread, not commission.
  # Some ECNs charge small commission + raw spreads.
  fees:
    structure: spread_only     # spread_only, raw_spread_commission, ecn
    maker_bps: 0.0             # No maker/taker in retail forex
    taker_bps: 0.0
    commission_per_lot: 0.0    # ECN mode: commission per 100k

    # Swap/rollover costs
    swap_enabled: true
    swap_data_source: oanda    # oanda, cache, manual
    swap_cache_path: "data/forex/swap_rates.json"
    swap_cache_ttl_hours: 24
    wednesday_triple_swap: true  # Wednesday = 3x swap for weekend

    # Spread profiles by pair type
    spread_profiles:
      institutional:
        major: 0.3             # EUR/USD, etc. in pips
        minor: 0.8
        cross: 1.5
        exotic: 10.0
      retail:
        major: 1.2
        minor: 2.5
        cross: 5.0
        exotic: 50.0
      conservative:
        major: 1.8
        minor: 3.5
        cross: 7.0
        exotic: 80.0

  # ---------------------------------------------------------------------------
  # Slippage: L2+ Parametric Model
  # ---------------------------------------------------------------------------
  # ForexParametricSlippageProvider with 8 factors
  slippage:
    level: "L2+"               # L2+ = Parametric TCA (not L3 LOB for OTC)
    provider: ForexParametricSlippageProvider
    profile: retail            # retail, institutional, conservative

    # Core Almgren-Chriss parameters
    impact_coef_base: 0.03     # Base k coefficient (lower than crypto)
    impact_coef_range: [0.02, 0.05]  # Adaptive range
    spread_pips: 1.2           # Default spread in pips

    # Factor adjustments
    session_adjustment: true   # Adjust for trading session
    volatility_adjustment: true
    carry_stress_adjustment: true
    dxy_correlation_adjustment: true
    news_event_adjustment: true
    asymmetric_impact: true    # Sell pressure during risk-off

    # Bounds
    min_slippage_pips: 0.1
    max_slippage_pips: 50.0

    # Whale detection (for large orders)
    whale_threshold: 0.005     # 0.5% of session ADV
    whale_twap_adjustment: 0.75

  # ---------------------------------------------------------------------------
  # OTC Dealer Simulation (NOT L3 LOB!)
  # ---------------------------------------------------------------------------
  # Unlike exchange LOBs, forex has dealer quotes with last-look.
  dealer_simulation:
    enabled: true
    provider: ForexDealerSimulator

    # Dealer pool
    num_dealers: 5
    dealer_profiles:
      tier1:
        count: 2
        spread_factor: 0.8     # Tightest spreads
        max_size_usd: 10000000  # $10M
        base_reject_prob: 0.02
        last_look_window_ms: 100
      tier2:
        count: 2
        spread_factor: 1.0
        max_size_usd: 5000000
        base_reject_prob: 0.05
        last_look_window_ms: 200
      tier3:
        count: 1
        spread_factor: 1.3     # Widest spreads
        max_size_usd: 1000000
        base_reject_prob: 0.10
        last_look_window_ms: 300

    # Last-look simulation
    last_look_enabled: true
    adverse_selection_threshold_pips: 0.3
    latency_arbitrage_detection: true

    # Quote behavior
    quote_flickering_enabled: true
    quote_validity_ms: 200
    rfq_threshold_usd: 5000000  # Request-for-quote above $5M

    # Execution statistics (for model calibration)
    track_execution_stats: true
    stats_window_trades: 1000

  # ---------------------------------------------------------------------------
  # Leverage Settings
  # ---------------------------------------------------------------------------
  # Forex allows high leverage (regulated by jurisdiction)
  leverage:
    max_leverage: 50.0         # CFTC limit for US retail
    default_leverage: 30.0     # Conservative default

    # Leverage by pair category (ESMA-style)
    by_category:
      major: 50                # EUR/USD, GBP/USD, etc.
      minor: 50
      cross: 50
      exotic: 20               # Higher margin for exotics

    # Margin levels
    margin_warning: 1.20       # 120% margin level warning
    margin_call: 1.00          # 100% margin level call
    stop_out: 0.50             # 50% margin level = liquidation

    # Jurisdiction presets
    jurisdictions:
      retail_us:
        major: 50
        minor: 50
        exotic: 20
      retail_eu:
        major: 30
        minor: 20
        exotic: 10
      professional:
        major: 100
        minor: 100
        exotic: 50
      institutional:
        major: 500
        minor: 200
        exotic: 100

  # ---------------------------------------------------------------------------
  # Position Sync
  # ---------------------------------------------------------------------------
  position_sync:
    enabled: true
    interval_sec: 30.0
    position_tolerance_pct: 0.01  # 1% tolerance
    price_tolerance_pct: 0.01
    auto_reconcile: false      # Manual reconciliation by default
    max_reconcile_units: 100000
    alert_on_discrepancy: true
    track_financing: true      # Track swap/financing costs

  # ---------------------------------------------------------------------------
  # Risk Guards (Forex-specific)
  # ---------------------------------------------------------------------------
  risk_guards:
    # Margin guards
    margin:
      enabled: true
      warning_threshold: 1.20
      call_threshold: 1.00
      stop_out_threshold: 0.50

    # Leverage guards
    leverage:
      enabled: true
      max_leverage: 50.0
      near_limit_threshold: 0.90
      concentration_limit_pct: 0.50  # 50% max in single pair

    # Swap cost tracking
    swap:
      enabled: true
      daily_limit_usd: 1000.0
      weekly_limit_usd: 5000.0
      alert_on_excessive: true

    # Session guards
    session:
      block_rollover_window: true
      block_weekend: true
      require_minimum_liquidity: 0.50  # 50% of normal

  # ---------------------------------------------------------------------------
  # Data Sources
  # ---------------------------------------------------------------------------
  data_sources:
    price_data: oanda          # Primary price feed
    interest_rates: fred       # FRED API for central bank rates
    economic_calendar: forexfactory  # Economic event calendar
    swap_rates: oanda          # Overnight swap rates
    dxy: yahoo                 # DX-Y.NYB for dollar index
    cot_data: cftc             # Commitments of Traders reports

    # Fallback sources
    fallbacks:
      price_data: dukascopy
      interest_rates: manual
      economic_calendar: oanda_labs

  # ---------------------------------------------------------------------------
  # Currency Pairs Configuration
  # ---------------------------------------------------------------------------
  pairs:
    # Major pairs (most liquid)
    majors:
      - EUR_USD
      - GBP_USD
      - USD_JPY
      - USD_CHF
      - AUD_USD
      - USD_CAD
      - NZD_USD

    # Minor pairs
    minors:
      - EUR_GBP
      - EUR_CHF
      - GBP_CHF
      - AUD_NZD
      - AUD_CAD

    # Cross pairs (JPY crosses)
    crosses:
      - EUR_JPY
      - GBP_JPY
      - AUD_JPY
      - CAD_JPY
      - CHF_JPY

    # Exotic pairs (higher spreads, lower liquidity)
    exotics:
      - USD_TRY
      - USD_ZAR
      - USD_MXN
      - EUR_TRY
      - EUR_PLN

  # ---------------------------------------------------------------------------
  # Pip Sizes (Critical for calculations)
  # ---------------------------------------------------------------------------
  # Standard: 0.0001 (4 decimal places)
  # JPY pairs: 0.01 (2 decimal places)
  pip_sizes:
    standard: 0.0001
    jpy: 0.01

    # Exceptions
    overrides:
      USD_HUF: 0.01
      USD_KRW: 0.01

# =============================================================================
# API Rate Limits
# =============================================================================
rate_limits:
  oanda:
    requests_per_second: 120
    burst: 200
    streaming_connections: 20

  ig:
    requests_per_second: 30
    burst: 50
    streaming_connections: 40

  dukascopy:
    requests_per_second: 10
    burst: 20
    streaming_connections: 5

# =============================================================================
# Logging Configuration
# =============================================================================
logging:
  level: INFO
  components:
    forex_dealer: DEBUG
    forex_session: INFO
    forex_position_sync: INFO
    forex_risk_guards: WARNING

# =============================================================================
# Feature Flags
# =============================================================================
features:
  # Enable/disable forex-specific features
  carry_trading: true
  cross_currency_momentum: true
  cot_positioning: true
  implied_volatility: true

  # Economic calendar integration
  economic_calendar:
    enabled: true
    lookback_hours: 2
    lookahead_hours: 24
    high_impact_spread_mult: 2.0
    block_around_events: false

# =============================================================================
# Validation Rules
# =============================================================================
validation:
  # Compatibility checks
  compatible_vendors:
    forex:
      - oanda
      - ig
      - dukascopy

  # Session compatibility
  calendar_compatibility:
    forex:
      - forex_24x5

  # Warnings
  warnings:
    - condition: "leverage > 50 and jurisdiction == 'retail_us'"
      message: "Leverage exceeds CFTC limit for US retail clients"
    - condition: "dealer_simulation.enabled == false"
      message: "Disabling dealer simulation may reduce execution realism"
