# -*- coding: utf-8 -*-
# Live Trading Configuration for Alpaca (US Equities)
#
# This configuration file is for live trading US stocks via Alpaca.
# It mirrors config_live.yaml but uses Alpaca adapters instead of Binance.
#
# Requirements:
#   1. pip install alpaca-py
#   2. Set environment variables: ALPACA_API_KEY, ALPACA_API_SECRET
#   3. Or update alpaca section below with credentials

mode: live
run_id: live-alpaca-run
logs_dir: logs
artifacts_dir: artifacts

# =============================================================================
# EXCHANGE CONFIGURATION
# =============================================================================

exchange:
  vendor: "alpaca"
  market_type: "EQUITY"

  alpaca:
    api_key: "${ALPACA_API_KEY}"
    api_secret: "${ALPACA_API_SECRET}"
    paper: true          # Use paper trading for safety (change to false for live)
    feed: "iex"          # "iex" (free) or "sip" (paid, real-time)
    extended_hours: false
    allow_extended_hours: true
    include_regulatory_fees: true

  trading_hours:
    allow_extended: true
    use_exchange_calendar: true

# =============================================================================
# RUNTIME SETTINGS
# =============================================================================

runtime_config: runtime.yaml

execution_config:
  notional_threshold: 10000.0
  large_order_algo: TWAP
  pov:
    participation: 0.10
    child_interval_s: 60
    min_child_notional: 20.0

max_signals_per_sec: 5.0
backoff_base_s: 2.0
max_backoff_s: 60.0

# Execution profile for US equities (market orders at open)
execution_profile: MKT_OPEN_NEXT_1H

execution_params:
  slippage_bps: 1.0      # Stocks typically have tighter spreads
  limit_offset_bps: 5.0
  ttl_steps: 0
  tif: DAY               # Day order (expires at market close)

execution:
  mode: bar
  enabled: true          # Enable live execution

# =============================================================================
# TIMING (US Market Hours)
# =============================================================================

timing:
  enforce_closed_bars: true
  timeframe_ms: 3600000   # 1h timeframe = 60 * 60 * 1000 ms
  close_lag_ms: 5000

clock_sync:
  refresh_sec: 300
  warn_threshold_ms: 500
  kill_threshold_ms: 2000
  max_step_ms: 1000
  attempts: 5

# =============================================================================
# DATA CONFIGURATION
# =============================================================================

data:
  timeframe: "1h"
  symbols_path: "data/universe/alpaca_symbols.json"

# Seasonality disabled for stocks (different patterns than crypto)
use_seasonality: false

# =============================================================================
# LATENCY MODEL (adjusted for equities)
# =============================================================================

latency:
  use_seasonality: false
  base_ms: 50           # Lower latency for regulated markets
  jitter_ms: 20
  spike_p: 0.001        # Rare spikes
  spike_mult: 3.0
  timeout_ms: 2000
  retries: 2
  min_ms: 0
  max_ms: 5000
  debug_log: false

# =============================================================================
# RISK MANAGEMENT
# =============================================================================

risk:
  enabled: true
  max_abs_position_qty: 0.0
  max_abs_position_notional: 50000.0   # Max $50k per position
  max_order_notional: 10000.0          # Max $10k per order
  max_orders_per_min: 30
  max_orders_window_s: 60
  daily_loss_limit: 1000.0             # Daily loss limit
  pause_seconds_on_violation: 300
  daily_reset_utc_hour: 14             # 9:30 AM ET = 14:30 UTC (start of market)
  max_entries_per_day: null
  max_total_notional: 100000.0         # Max $100k total exposure
  max_total_exposure_pct: 0.5          # Max 50% of equity

# =============================================================================
# QUANTIZER (Equity rules)
# =============================================================================

quantizer:
  # Use Alpaca exchange info adapter instead of static file
  use_adapter: true
  strict_filters: true
  enforce_percent_price_by_side: false  # Not applicable for stocks
  auto_refresh_days: 7

# =============================================================================
# PIPELINE
# =============================================================================

pipeline:
  enabled: true
  stages:
    closed_bar:
      enabled: true
    windows:
      enabled: true
    anomaly:
      enabled: true
    extreme:
      enabled: true
    policy:
      enabled: true
    risk:
      enabled: true
    ttl:
      enabled: false    # TTL less relevant for stocks
    dedup:
      enabled: true
    throttle:
      enabled: true
    publish:
      enabled: true

# =============================================================================
# COMPONENTS (using Alpaca adapters)
# =============================================================================

components:
  market_data:
    target: adapters.alpaca:AlpacaMarketDataAdapter
    params:
      timeframe: "1h"

  executor:
    target: impl_sim_executor:SimExecutor
    params:
      symbol: "AAPL"     # Default symbol (can be overridden)

  feature_pipe:
    target: feature_pipe:FeaturePipe
    params: {}

  policy:
    target: strategies.momentum:MomentumStrategy
    params: {}

  risk_guards:
    target: impl_risk_basic:RiskBasicImpl
    params: {}

# =============================================================================
# SHUTDOWN
# =============================================================================

shutdown:
  grace_period: 5.0
  drain_policy: graceful
  timeouts:
    stop: 10.0
    flush: 10.0
    finalize: 5.0

# =============================================================================
# TTL (disabled for stocks)
# =============================================================================

ttl:
  enabled: false
