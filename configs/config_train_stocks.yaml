# =============================================================================
# STOCK TRAINING CONFIGURATION (Phase 3)
# =============================================================================
# Training configuration for US equities via Alpaca/Polygon data providers.
# Based on config_train.yaml with stock-specific adjustments.
#
# Key differences from crypto:
# - Trading hours enforcement (9:30-16:00 ET)
# - No Fear & Greed index (use VIX instead)
# - Different fee structure (commission-free with regulatory fees)
# - Different liquidity patterns
# =============================================================================

mode: train
run_id: stock-training
logs_dir: logs/stocks
artifacts_dir: artifacts/stocks
seasonality_log_level: INFO

# ASSET CLASS CONFIGURATION
asset_class: equity  # Options: crypto, equity
data_vendor: alpaca  # Options: alpaca, polygon (for data fetching)

execution_profile: MKT_OPEN_NEXT_4H
execution_params:
  limit_offset_bps: 0.0
  ttl_steps: 0
  tif: GTC

execution:
  enabled: true
  mode: bar

execution_config:
  notional_threshold: 10000.0
  large_order_algo: TWAP
  pov:
    participation: 0.10
    child_interval_s: 60
    min_child_notional: 20.0

# Stock market seasonality (US market hours)
liquidity_seasonality_path: null  # No crypto-style seasonality
use_seasonality: false

market: equity

# =============================================================================
# DATA CONFIGURATION
# =============================================================================
data:
  timeframe: "4h"
  asset_class: equity

  # Data source: local files or API
  source: local  # Options: local, alpaca, polygon

  # Local file paths (for source=local)
  paths:
    - "data/stocks/*.parquet"
    - "data/stocks/*.feather"

  # API configuration (for source=alpaca or polygon)
  api:
    symbols:
      - "AAPL"
      - "MSFT"
      - "GOOGL"
      - "AMZN"
      - "NVDA"
      - "META"
      - "TSLA"
      - "SPY"
      - "QQQ"
      - "IWM"
    # Credentials from environment: ALPACA_API_KEY, ALPACA_API_SECRET, POLYGON_API_KEY

  # Training window
  train_start_ts: 1609459200     # 2021-01-01T00:00:00Z
  train_end_ts: 1735689600       # 2025-01-01T00:00:00Z

  val_start_ts: 1735689600       # 2025-01-01T00:00:00Z
  val_end_ts: 1746057600         # 2025-05-01T00:00:00Z

  test_start_ts: 1746057600      # 2025-05-01T00:00:00Z
  test_end_ts: 1759276800        # 2025-10-01T00:00:00Z

  # Stock-specific options
  filter_trading_hours: true     # Only use data from regular trading hours
  include_extended_hours: false  # Include pre-market and after-hours

# =============================================================================
# MODEL CONFIGURATION
# =============================================================================
model:
  algo: "ppo"

  # OPTIMIZER - Same as crypto
  optimizer_class: AdaptiveUPGD
  optimizer_kwargs:
    lr: 1.0e-4
    weight_decay: 0.001
    sigma: 0.001
    beta_utility: 0.999
    beta1: 0.9
    beta2: 0.999
    adaptive_noise: true

  # VGS Configuration
  vgs:
    enabled: true
    accumulation_steps: 4
    warmup_steps: 10
    eps: 1.0e-6
    clip_threshold: 10.0
    min_scaling_factor: 0.1      # VGS v3.2: prevent gradient blocking
    variance_cap: 50.0           # VGS v3.2: cap extreme variance

  optimizer_lr_min: &default_min_lr 5.0e-6
  scheduler_min_lr: *default_min_lr

  params:
    learning_rate: 1.0e-4
    gamma: 0.99
    gae_lambda: 0.95
    clip_range: 0.10

    clip_range_vf: 0.7
    vf_clip_warmup_updates: 10

    ent_coef: 0.001
    ent_coef_final: 0.001
    ent_coef_decay_steps: 400
    ent_coef_min: 0.0005
    ent_coef_plateau_window: 24
    ent_coef_plateau_tolerance: 0.002
    ent_coef_plateau_min_updates: 40

    vf_coef: 1.8
    value_clip_limit: null
    vf_coef_warmup: 0
    vf_coef_warmup_updates: 0
    vf_bad_explained_scale: 1.0
    vf_bad_explained_floor: 0.0
    bad_explained_patience: 2

    max_grad_norm: 0.5
    n_steps: 2048
    n_epochs: 4
    batch_size: 64
    microbatch_size: 200
    seed: 20240518

    kl_early_stop: true
    kl_exceed_stop_fraction: 0.15
    kl_epoch_decay: 1.0
    kl:
      target_kl: 0.08
      early_stop:
        enabled: true
        use_ema: true
        ema_updates: 10
        ema_alpha: null
        exceed_stop_fraction: 0.15
        consec_minibatches: 2
        absolute_stop_factor: 2.5
      use_lr_decay: false
      penalty:
        type: adaptive_beta
        beta_init: 0.01
        pid:
          kp: 0.5
          ki: 0.05
          kd: 0.10
          beta_min: 1.0e-4
          beta_max: 1.0

    optimizer_lr_min: *default_min_lr

    # STOCK-SPECIFIC: Lower turnover penalty (lower fees)
    trade_frequency_penalty: 0.0
    turnover_penalty_coef: 0.0001   # Lower than crypto (commission-free)
    reward_return_clip: 10.0
    turnover_norm_cap: 1.0
    reward_cap: 10.0

    reward_clip:
      adaptive: true
      atr_window: 14
      hard_cap_pct: 2.0
      multiplier: 4.0

    cql_alpha: 0.0
    cql_beta: 5.0
    cvar_alpha: 0.05
    cvar_weight: 0.15
    cvar_activation_threshold: 0.15
    cvar_activation_hysteresis: 0.05
    cvar_ramp_updates: 12
    cvar_cap: 0.5

    use_torch_compile: false
    bc_warmup_steps: 200000
    bc_decay_steps: 800000
    bc_final_coef: 0.0

    # Twin Critics (same as crypto)
    use_twin_critics: true
    num_atoms: 21
    v_min: -10.0
    v_max: 10.0
    v_range_ema_alpha: 0.005

    value_scale:
      ema_beta: 0.9
      max_rel_step: 0.5
      std_floor: 0.003
      window_updates: 16
      warmup_updates: 6
      freeze_after_updates: null
      never_freeze: true
      max_change_pct: 0.06
      target_scale_ema_beta: 0.9
      range_max_rel_step: 0.5
      freeze_after: null
      stability:
        min_explained_variance: 0.0
        max_abs_p95: 6.0
        patience: 2

    value_scale_controller: {}
    clip_range_warmup: 0.18
    clip_range_warmup_updates: 16
    critic_grad_warmup_updates: 0
    entropy_boost_factor: 1.5

# =============================================================================
# ENVIRONMENT CONFIGURATION
# =============================================================================
env:
  decision_timing: CLOSE_TO_OPEN

  # No-trade windows (stock-specific)
  no_trade:
    enabled: true
    policy: ignore
    # Skip non-trading hours for stocks
    enforce_trading_hours: true

  # Stock market session
  session:
    calendar: us_equity          # US market calendar (9:30-16:00 ET)
    pre_open_keepout_bars: 0     # No pre-market trading
    post_close_keepout_bars: 0
    extended_hours: false        # Disable extended hours

  liquidity:
    min_adv_usd: 1000000        # Minimum $1M average daily volume
    min_bar_quote_volume: 10000  # Minimum bar volume

  spreads:
    max_spread_bps: 50          # Stocks typically have tighter spreads

  warmup:
    min_bars: 60

# =============================================================================
# EXCHANGE CONFIGURATION
# =============================================================================
exchange:
  vendor: alpaca                 # Or "polygon" for data
  market_type: EQUITY

  alpaca:
    paper: true                  # Use paper trading for testing
    feed: iex                    # "iex" (free) or "sip" (paid)
    extended_hours: false

# =============================================================================
# FEES CONFIGURATION (Stock-specific)
# =============================================================================
fees:
  structure: flat                # Commission-free for most brokers
  maker_bps: 0.0
  taker_bps: 0.0

  # Regulatory fees (SEC/FINRA on sells)
  regulatory:
    enabled: true
    sec_fee_per_million: 27.80   # SEC fee per $1M of sales
    taf_fee_per_share: 0.000166  # TAF fee per share
    taf_fee_cap: 8.30            # TAF cap per trade

# =============================================================================
# RISK CONFIGURATION
# =============================================================================
risk:
  max_position: 1.0              # 100% max position
  max_drawdown: 0.20             # 20% max drawdown
  daily_loss_limit: 0.05         # 5% daily loss limit

  # PDT rule enforcement (for accounts < $25k)
  pdt_rule:
    enabled: false               # Enable if account < $25k
    min_equity: 25000.0

# =============================================================================
# TRAINING CONFIGURATION
# =============================================================================
training:
  total_timesteps: 2000000
  n_envs: 4
  verbose: 1

  # Evaluation
  eval_freq: 10000
  n_eval_episodes: 5

  # Checkpointing
  save_freq: 50000
  save_path: "models/stocks"

  # TensorBoard
  tensorboard: true
  tb_log_name: "stock_ppo"
