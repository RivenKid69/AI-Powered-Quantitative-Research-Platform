# ═══════════════════════════════════════════════════════════════════════════════
# FUTURES TRAINING CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════
# Phase 8 - Multi-Futures Training Pipeline
#
# This configuration is optimized for training RL models on crypto perpetual futures.
# For CME/index futures, use config_futures_unified.yaml with futures_type: index
#
# Usage:
#   python train_model_multi_patch.py --config configs/config_train_futures.yaml
# ═══════════════════════════════════════════════════════════════════════════════

mode: train
run_id: futures-training
logs_dir: logs/futures
artifacts_dir: artifacts/futures
seasonality_log_level: INFO

# ─────────────────────────────────────────────────────────────────────────────
# ASSET CLASS & VENDOR
# ─────────────────────────────────────────────────────────────────────────────
asset_class: crypto_futures
data_vendor: binance
market: futures

# ─────────────────────────────────────────────────────────────────────────────
# DATA SOURCES
# ─────────────────────────────────────────────────────────────────────────────
data:
  timeframe: "4h"
  paths:
    - "data/futures/*.parquet"

  # Funding rate history (required for perpetuals)
  funding_paths:
    - "data/futures/*_funding.parquet"

  # Mark price for accurate liquidation simulation
  mark_price_paths:
    - "data/futures/*_mark_*.parquet"

  # Optional: open interest data
  open_interest_paths:
    - "data/futures/*_oi.parquet"

  # Optional: liquidation data for cascade simulation
  liquidation_paths:
    - "data/futures/*_liquidations.parquet"

  # Time ranges
  train_start_ts: 1609459200       # 2021-01-01T00:00:00Z
  train_end_ts: 1743465599         # 2025-03-31T23:59:59Z
  val_start_ts: 1743465600         # 2025-04-01T00:00:00Z
  val_end_ts: 1751327999           # 2025-06-30T23:59:59Z
  test_start_ts: 1751328000        # 2025-07-01T00:00:00Z
  test_end_ts: 1759276799          # 2025-09-30T23:59:59Z

  # Data validation
  validation:
    check_gaps: true
    max_gap_bars: 2
    check_volume_zeros: true
    min_history_bars: 1000

# ─────────────────────────────────────────────────────────────────────────────
# FUTURES CONFIGURATION
# ─────────────────────────────────────────────────────────────────────────────
futures:
  # Core settings
  initial_leverage: 10
  max_leverage: 50
  margin_mode: cross               # cross, isolated

  # Reward integration
  include_funding_in_reward: true
  liquidation_penalty: -10.0

  # Leverage brackets (Binance USDT-M style)
  leverage_brackets:
    - notional_cap: 50000
      max_leverage: 125
      maint_margin_rate: 0.004
    - notional_cap: 250000
      max_leverage: 100
      maint_margin_rate: 0.005
    - notional_cap: 1000000
      max_leverage: 50
      maint_margin_rate: 0.01
    - notional_cap: 10000000
      max_leverage: 20
      maint_margin_rate: 0.025
    - notional_cap: null           # Unlimited
      max_leverage: 10
      maint_margin_rate: 0.05

# ─────────────────────────────────────────────────────────────────────────────
# FUNDING RATE CONFIGURATION (Perpetuals)
# ─────────────────────────────────────────────────────────────────────────────
funding:
  enabled: true
  interval_hours: 8
  times_utc: ["00:00", "08:00", "16:00"]
  include_in_reward: true
  clamp_rate_bps: 75               # Max 0.75% per interval
  pro_rata_settlement: true

  # Funding risk limits
  limits:
    max_cumulative_24h_bps: 150    # Max 1.5% daily
    skip_when_rate_exceeds_bps: 50 # Avoid high funding positions

# ─────────────────────────────────────────────────────────────────────────────
# LIQUIDATION CONFIGURATION
# ─────────────────────────────────────────────────────────────────────────────
liquidation:
  penalty_reward: -10.0
  simulate_cascade: true
  insurance_fund_deduction: true
  adl_simulation: true
  cross_margin_priority: highest_loss

# ─────────────────────────────────────────────────────────────────────────────
# SESSION & TRADING HOURS
# ─────────────────────────────────────────────────────────────────────────────
env:
  session:
    calendar: crypto_24x7

# ─────────────────────────────────────────────────────────────────────────────
# FEES (Binance USDT-M Futures)
# ─────────────────────────────────────────────────────────────────────────────
fees:
  structure: maker_taker
  maker_bps: 2.0
  taker_bps: 4.0
  use_bnb_discount: false

# ─────────────────────────────────────────────────────────────────────────────
# EXECUTION & SLIPPAGE
# ─────────────────────────────────────────────────────────────────────────────
execution_profile: MKT_OPEN_NEXT_4H
execution:
  enabled: true
  mode: bar
  level: L2                        # L2 (parametric), L3 (LOB simulation)

slippage:
  profile: crypto_futures
  k: 0.09                          # Impact coefficient
  default_spread_bps: 4.0
  min_slippage_bps: 0.5
  max_slippage_bps: 500.0

  # Futures-specific adjustments
  funding_stress_sensitivity: 8.0
  liquidation_cascade_multiplier: 1.5
  oi_imbalance_sensitivity: 0.3

execution_params:
  limit_offset_bps: 0.0
  ttl_steps: 0
  tif: GTC

execution_config:
  notional_threshold: 10000.0
  large_order_algo: TWAP
  pov:
    participation: 0.10
    child_interval_s: 60
    min_child_notional: 20.0

# ─────────────────────────────────────────────────────────────────────────────
# RISK MANAGEMENT
# ─────────────────────────────────────────────────────────────────────────────
risk:
  max_position_usd: 1000000
  max_open_positions: 5
  max_leverage_used: 0.8
  max_drawdown_pct: 15
  daily_loss_limit_usd: 10000
  max_funding_exposure_24h_pct: 2.0
  max_concentration_pct: 50

  kill_switch:
    enabled: true
    triggers:
      - consecutive_losses: 5
      - drawdown_pct: 10
      - daily_loss_usd: 5000

# ─────────────────────────────────────────────────────────────────────────────
# FEATURES (Futures-specific)
# ─────────────────────────────────────────────────────────────────────────────
features:
  include_funding_features: true
  include_basis_features: true
  include_oi_features: true
  include_liquidation_features: true
  include_term_structure: false

  funding_lookback: 8              # 8 funding periods
  oi_lookback: 20
  basis_lookback: 20

# ─────────────────────────────────────────────────────────────────────────────
# MODEL CONFIGURATION
# ─────────────────────────────────────────────────────────────────────────────
model:
  algo: "ppo"
  policy: RecurrentActorCriticPolicy
  path: "models/futures_ppo.zip"

  # OPTIMIZER (AdaptiveUPGD)
  optimizer_class: AdaptiveUPGD
  optimizer_kwargs:
    lr: 1.0e-4
    weight_decay: 0.001
    sigma: 0.001
    beta_utility: 0.999
    beta1: 0.9
    beta2: 0.999
    adaptive_noise: true

  # VGS Configuration
  vgs:
    enabled: true
    accumulation_steps: 4
    warmup_steps: 10
    eps: 1.0e-6
    clip_threshold: 10.0

  optimizer_lr_min: &default_min_lr 5.0e-6
  scheduler_min_lr: *default_min_lr

  params:
    learning_rate: 1.0e-4
    gamma: 0.99
    gae_lambda: 0.95
    clip_range: 0.10
    clip_range_vf: 0.7
    vf_clip_warmup_updates: 10
    ent_coef: 0.001
    ent_coef_final: 0.001
    ent_coef_decay_steps: 400
    ent_coef_min: 0.0005
    vf_coef: 1.8
    max_grad_norm: 0.5
    n_steps: 2048
    n_epochs: 4
    batch_size: 64
    microbatch_size: 200
    seed: 20240518

    # KL divergence control
    kl_early_stop: true
    kl_exceed_stop_fraction: 0.15
    kl:
      target_kl: 0.08
      early_stop:
        enabled: true
        use_ema: true
        ema_updates: 10
        exceed_stop_fraction: 0.15
        consec_minibatches: 2
        absolute_stop_factor: 2.5

    # Reward configuration
    reward_return_clip: 10.0
    turnover_penalty_coef: 0.0005
    turnover_norm_cap: 1.0
    reward_cap: 10.0
    reward_clip:
      adaptive: true
      atr_window: 14
      hard_cap_pct: 2.0
      multiplier: 4.0

    # Distributional RL & Twin Critics
    use_twin_critics: true
    num_atoms: 21
    v_min: -10.0
    v_max: 10.0
    v_range_ema_alpha: 0.005
    cvar_alpha: 0.05
    cvar_weight: 0.15
    cvar_activation_threshold: 0.15
    cvar_activation_hysteresis: 0.05
    cvar_ramp_updates: 12
    cvar_cap: 0.5

    # Value scale configuration
    value_scale:
      ema_beta: 0.9
      max_rel_step: 0.5
      std_floor: 0.003
      window_updates: 16
      warmup_updates: 6
      freeze_after_updates: null
      never_freeze: true
      max_change_pct: 0.06

# ─────────────────────────────────────────────────────────────────────────────
# LOGGING & MONITORING
# ─────────────────────────────────────────────────────────────────────────────
logging:
  level: INFO
  tensorboard: true
  tensorboard_dir: "runs/futures"

  # Futures-specific metrics
  track_funding_pnl: true
  track_liquidation_distance: true
  track_margin_usage: true
