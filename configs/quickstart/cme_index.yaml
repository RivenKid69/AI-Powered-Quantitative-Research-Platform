# =============================================================================
# CME EQUITY INDEX FUTURES - Quick Start Reference Pipeline
# =============================================================================
#
# Стратегия: Momentum на E-mini индексных фьючерсах
# Asset Class: CME Futures (via Interactive Brokers)
# Сложность: ⭐⭐⭐⭐⭐ (Expert)
#
# Характеристики:
#   - Globex часы (Sun 18:00 - Fri 17:00 ET)
#   - SPAN margin (risk-based)
#   - Daily settlement (variation margin)
#   - Contract rollover (quarterly)
#   - Per-contract commissions
#
# Требования:
#   - Interactive Brokers TWS/Gateway запущен
#   - Port 7497 (paper) или 7496 (live)
#   - API connections enabled
#
# Запуск:
#   python scripts/download_cme_data.py --symbols ES NQ --days 365
#   python script_backtest.py --config configs/quickstart/cme_index.yaml
#   python train_model_multi_patch.py --config configs/quickstart/cme_index.yaml
#
# =============================================================================

# -----------------------------------------------------------------------------
# БАЗОВЫЕ НАСТРОЙКИ
# -----------------------------------------------------------------------------
mode: train
run_id: cme_index
logs_dir: logs/quickstart
artifacts_dir: artifacts/quickstart

asset_class: futures
market: cme                       # CME Group (via IB)
data_vendor: ib

# -----------------------------------------------------------------------------
# ДАННЫЕ
# -----------------------------------------------------------------------------
data:
  timeframe: "4h"
  paths: ["data/futures/cme/*.parquet"]

  # Символы (equity index futures)
  symbols:
    - "ES"                        # E-mini S&P 500 ($50 × index)
    - "NQ"                        # E-mini NASDAQ 100 ($20 × index)

  # Периоды
  train_start_ts: 1640995200
  train_end_ts: 1735689599
  val_start_ts: 1735689600
  val_end_ts: 1743465599
  test_start_ts: 1743465600
  test_end_ts: 1751327999

# -----------------------------------------------------------------------------
# МОДЕЛЬ
# -----------------------------------------------------------------------------
model:
  algo: "ppo"

  optimizer_class: AdaptiveUPGD
  optimizer_kwargs:
    lr: 1.0e-4
    weight_decay: 0.001
    sigma: 0.001
    beta_utility: 0.999
    beta1: 0.9
    beta2: 0.999
    adaptive_noise: true

  vgs:
    enabled: true
    accumulation_steps: 4
    warmup_steps: 10
    clip_threshold: 10.0

  params:
    learning_rate: 1.0e-4
    gamma: 0.99
    gae_lambda: 0.95
    clip_range: 0.10
    clip_range_vf: 0.7
    ent_coef: 0.001
    vf_coef: 1.8
    max_grad_norm: 0.5
    n_steps: 2048
    n_epochs: 4
    batch_size: 64
    seed: 42

    use_twin_critics: true
    num_atoms: 21
    v_min: -10.0
    v_max: 10.0

    cvar_alpha: 0.05
    cvar_weight: 0.20              # Higher for futures risk

# -----------------------------------------------------------------------------
# ОКРУЖЕНИЕ
# -----------------------------------------------------------------------------
env:
  decision_timing: CLOSE_TO_OPEN

  session:
    calendar: cme_globex           # Sun 18:00 - Fri 17:00 ET
    maintenance_window: true       # Daily 16:15-16:30 ET
    dst_aware: true

  liquidity:
    min_adv_usd: 0
    min_bar_quote_volume: 0

  no_trade:
    enabled: true
    policy: hold
    maintenance_window: true       # No trading during maintenance

# -----------------------------------------------------------------------------
# CONTRACT SPECIFICATIONS
# -----------------------------------------------------------------------------
contracts:
  ES:
    multiplier: 50.0               # $50 × S&P 500 index
    tick_size: 0.25
    tick_value: 12.50              # $12.50 per tick
    margin_initial: 12500          # ~$12,500 initial margin
    margin_maintenance: 11000      # ~$11,000 maintenance

  NQ:
    multiplier: 20.0               # $20 × NASDAQ 100 index
    tick_size: 0.25
    tick_value: 5.00               # $5 per tick
    margin_initial: 18000          # ~$18,000 initial margin
    margin_maintenance: 15000      # ~$15,000 maintenance

# -----------------------------------------------------------------------------
# LEVERAGE & MARGIN (SPAN-based)
# -----------------------------------------------------------------------------
leverage:
  margin_mode: span               # CME SPAN margin
  use_intraday_margin: true       # Lower margin during RTH
  margin_call_threshold: 1.10     # 110% margin ratio
  liquidation_threshold: 1.00     # 100% = forced liquidation

# -----------------------------------------------------------------------------
# CONTRACT ROLLOVER
# -----------------------------------------------------------------------------
rollover:
  enabled: true
  roll_days_before_expiry: 8      # Standard ES/NQ roll
  roll_method: calendar_spread    # Use calendar spread for roll

  # Quarterly expirations (H, M, U, Z = Mar, Jun, Sep, Dec)
  expiration_months: [3, 6, 9, 12]
  expiration_day: third_friday

# -----------------------------------------------------------------------------
# DAILY SETTLEMENT
# -----------------------------------------------------------------------------
settlement:
  enabled: true
  settlement_time_et: "15:30"     # 3:30 PM ET for equity index
  variation_margin: true          # Track daily variation margin

# -----------------------------------------------------------------------------
# CIRCUIT BREAKERS (Rule 80B)
# -----------------------------------------------------------------------------
circuit_breakers:
  enabled: true
  level_1_pct: -7.0               # 15-min halt
  level_2_pct: -13.0              # 15-min halt
  level_3_pct: -20.0              # Trading halted for day
  overnight_limit_pct: 5.0        # ±5% ETH limit

# -----------------------------------------------------------------------------
# ДЕЙСТВИЯ
# -----------------------------------------------------------------------------
algo:
  actions:
    long_only: false               # Allow shorts (hedging)

  action_wrapper:
    fixed_type: MARKET
    lock_price_offset: true
    fixed_price_offset_ticks: 0
    bins_vol: 5                    # [-100%, -50%, 0%, 50%, 100%]
    max_asset_weight: 1.0

# -----------------------------------------------------------------------------
# КОМИССИИ (Per-contract)
# -----------------------------------------------------------------------------
fees:
  structure: per_contract
  per_contract:
    ES: 1.29                       # $1.29 per contract (CME)
    NQ: 1.29                       # $1.29 per contract (CME)

  # Broker commission (IB typical)
  broker_per_contract: 0.85        # $0.85 per contract

  regulatory:
    enabled: true
    nfa_fee: 0.02                  # NFA fee per contract

# -----------------------------------------------------------------------------
# SLIPPAGE (CME-specific)
# -----------------------------------------------------------------------------
slippage:
  profile: cme_equity_index
  k: 0.03                          # Low impact for liquid products

  # Session-aware
  session_multipliers:
    rth: 1.0                       # Regular trading hours (best)
    eth: 1.5                       # Electronic (overnight)
    pre_open: 1.25                 # Pre-open period

  # Settlement period adjustment
  settlement_period_multiplier: 1.3

  dynamic:
    enabled: true
    use_session_curve: true

# -----------------------------------------------------------------------------
# РИСК-МЕНЕДЖМЕНТ (CME-specific)
# -----------------------------------------------------------------------------
risk:
  enabled: true
  max_contracts: 10                # Max contracts per symbol
  daily_loss_limit: 0.03           # -3% daily loss limit

  cme:
    span_margin_guard:
      enabled: true
      warning_ratio: 1.50
      danger_ratio: 1.20
      critical_ratio: 1.05

    position_limit_guard:
      enabled: true
      enforce_speculative_limits: true

    circuit_breaker_guard:
      enabled: true
      prevent_trades_on_halt: true

    settlement_risk_guard:
      enabled: true
      warn_minutes_before: 60
      block_new_positions_minutes: 15

    rollover_guard:
      enabled: true
      warn_days_before: 8
      block_new_positions_days: 1

# -----------------------------------------------------------------------------
# REWARD
# -----------------------------------------------------------------------------
reward:
  use_portfolio_pnl: true
  turnover_penalty_coef: 0.0005
  include_settlement_pnl: true     # Include variation margin in P&L
  clip:
    adaptive: true
    atr_window: 14
    hard_cap_pct: 2.0
    multiplier: 4.0

# -----------------------------------------------------------------------------
# EXECUTION SIMULATION
# -----------------------------------------------------------------------------
execution:
  enabled: true
  mode: bar
  use_settlement_price: true       # Use official settlement for EOD

execution_profile: MKT_OPEN_NEXT_4H
execution_params:
  limit_offset_bps: 0.0
  ttl_steps: 0
  tif: DAY                         # Day orders (expire at session end)

# -----------------------------------------------------------------------------
# КОМПОНЕНТЫ
# -----------------------------------------------------------------------------
components:
  market_data:
    target: impl_offline_data:OfflineCSVBarSource
    params:
      paths: ["data/futures/cme/*.parquet"]
      timeframe: "4h"
  executor:
    target: impl_sim_executor:SimExecutor
    params:
      symbol: "ES"
  feature_pipe:
    target: feature_pipe:FeaturePipe
    params: {}
  policy:
    target: strategies.momentum:MomentumStrategy
    params: {}
  backtest_engine:
    target: service_backtest:ServiceBacktest
    params: {}

# -----------------------------------------------------------------------------
# CME-SPECIFIC FEATURES
# -----------------------------------------------------------------------------
cme_features:
  # VIX integration (fear gauge for equity index)
  vix:
    enabled: true
    symbol: "^VIX"
    regime_thresholds:
      low: 12
      normal: 20
      elevated: 30
      extreme: 50

  # Term structure (contango/backwardation)
  term_structure:
    enabled: true
    front_month: true
    back_month: true

  # Commitment of Traders (COT)
  cot:
    enabled: false                 # Requires CFTC data
